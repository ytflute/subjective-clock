# 智慧城市選擇與訪問次數追蹤系統

## 功能概述

這個系統實現了兩個主要功能：
1. **智慧城市選擇**：優先推薦用戶尚未訪問過的城市
2. **城市訪問次數追蹤**：在查看日誌時顯示城市重複訪問資訊

## 智慧城市選擇機制

### 工作流程
1. 前端收集用戶的城市訪問統計資料
2. 將訪問統計資料傳遞給後端API
3. 後端在符合條件的城市中，優先選擇訪問次數最少的城市

### 選擇優先級
1. **時區匹配**：首先確保城市符合目標時區偏移
2. **緯度匹配**：根據時間計算的目標緯度選擇最接近的城市
3. **訪問歷史**：在同等條件下，優先選擇未訪問或訪問次數最少的城市

### 實現細節
- 前端：`getUserCityVisitStats()`函數收集用戶歷史記錄
- API參數：新增`userCityVisitStats`參數
- 後端邏輯：基於訪問次數進行智慧過濾

```javascript
// 城市選擇邏輯示例
const citiesWithStats = candidateCities.map(city => ({
    ...city,
    visitCount: cityVisitStats[city.name] || 0
}));

// 選擇訪問次數最少的城市
const minVisitCount = Math.min(...citiesWithStats.map(city => city.visitCount));
const leastVisitedCities = citiesWithStats.filter(city => city.visitCount === minVisitCount);
```

## 城市訪問次數追蹤

### 功能說明
- 在查看歷史日誌時，會顯示「這是你第 X 次拜訪這座城市」
- 只有重複訪問的城市（第2次以上）才會顯示此資訊
- 按時間順序計算訪問次數

### 實現方式
- 新增`calculateCityVisitNumber()`函數
- 查詢用戶歷史記錄，統計同一城市的訪問次數
- 在日誌彈窗中顯示城市訪問資訊

### 顯示格式
```
基本資訊
記錄時間：2024年12月14日...
甦醒地點：東京 (Tokyo), 日本 (Japan)
城市訪問：這是你第 3 次拜訪這座城市  ←— 新增功能
時區：Asia/Tokyo
```

## 技術特點

### 效能優化
- 城市訪問統計採用記憶體快取機制
- 避免重複查詢資料庫
- 異步處理確保用戶體驗流暢

### 錯誤處理
- API調用失敗時採用預設選擇邏輯
- 資料解析錯誤時返回空統計
- 確保功能降級但不影響核心功能

### 資料一致性
- 使用城市英文名作為唯一標識
- 排除"Unknown Planet"等特殊記錄
- 按記錄時間排序確保計數準確

## 使用者體驗改善

1. **探索性**：鼓勵用戶發現新的城市和文化
2. **記憶性**：追蹤訪問歷史，增加個人化體驗
3. **透明性**：清楚顯示訪問次數資訊
4. **連續性**：保持現有功能的完整性

這個系統在保持原有功能完整性的同時，增加了智慧化的城市推薦機制，讓每次甦醒都更有探索的樂趣。 