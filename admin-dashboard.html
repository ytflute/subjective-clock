<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»è§€æ™‚é˜ - ç®¡ç†å“¡å„€è¡¨æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .search-box input:focus {
            border-color: #4facfe;
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
            font-size: 18px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .table-container {
            overflow-x: auto;
            max-height: 70vh;
            margin: 0 30px 30px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .data-table th,
        .data-table td {
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            transition: background 0.3s;
        }

        .data-table th:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        .data-table th.sortable::after {
            content: ' â†•';
            opacity: 0.5;
        }

        .data-table th.sort-asc::after {
            content: ' â†‘';
            opacity: 1;
        }

        .data-table th.sort-desc::after {
            content: ' â†“';
            opacity: 1;
        }

        .data-table tbody tr {
            transition: background-color 0.3s;
        }

        .data-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .data-table tbody tr:nth-child(even) {
            background-color: #fbfbfb;
        }

        .breakfast-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s;
            border: 2px solid #ddd;
        }

        .breakfast-thumbnail:hover {
            transform: scale(1.1);
            border-color: #4facfe;
        }

        .user-id {
            font-weight: 600;
            color: #495057;
        }

        .city-name {
            color: #28a745;
            font-weight: 500;
        }

        .country-name {
            color: #6f42c1;
            font-weight: 500;
        }

        .date-time {
            white-space: nowrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .url-link {
            color: #007bff;
            text-decoration: none;
            word-break: break-all;
            max-width: 200px;
            display: inline-block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .url-link:hover {
            text-decoration: underline;
        }

        .no-image {
            width: 60px;
            height: 60px;
            background: #e9ecef;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 12px;
            text-align: center;
            border: 2px solid #ddd;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #4facfe;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        .error {
            text-align: center;
            padding: 50px;
            color: #dc3545;
            font-size: 18px;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                min-width: auto;
            }

            .data-table th,
            .data-table td {
                padding: 10px 8px;
                font-size: 14px;
            }

            .header h1 {
                font-size: 2em;
            }
        }

        /* å½ˆå‡ºçª—å£æ¨£å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            max-height: 90%;
        }

        .modal-content img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-close:hover {
            color: #ccc;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ… ä¸»è§€æ™‚é˜ç®¡ç†å“¡å„€è¡¨æ¿</h1>
            <p>æŸ¥çœ‹æ‰€æœ‰ä½¿ç”¨è€…çš„ç”¦é†’è¨˜éŒ„èˆ‡è»Œè·¡</p>
        </div>

        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="æœå°‹ä½¿ç”¨è€…ä»£è™Ÿã€åŸå¸‚æˆ–åœ‹å®¶...">
                <span class="search-icon">ğŸ”</span>
            </div>
            <button class="btn btn-primary" onclick="loadAllUserData()">ğŸ”„ é‡æ–°è¼‰å…¥è³‡æ–™</button>
            <button class="btn btn-secondary" onclick="exportToCSV()">ğŸ“¥ åŒ¯å‡º CSV</button>
        </div>

        <div id="loadingIndicator" class="loading">
            <div class="spinner"></div>
            æ­£åœ¨è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™...
        </div>

        <div id="errorMessage" class="error" style="display: none;"></div>

        <div class="table-container" id="tableContainer" style="display: none;">
            <table class="data-table" id="dataTable">
                <thead>
                    <tr>
                        <th class="sortable" data-column="userId">ä½¿ç”¨è€…ä»£è™Ÿ</th>
                        <th class="sortable" data-column="date">æ—¥æœŸ</th>
                        <th class="sortable" data-column="time">æ™‚é–“</th>
                        <th class="sortable" data-column="city">City</th>
                        <th class="sortable" data-column="country">Country</th>
                        <th class="sortable" data-column="breakfast">æ—©é¤ç…§ç‰‡</th>
                        <th class="sortable" data-column="imageUrl">ç…§ç‰‡ç¶²å€</th>
                        <th class="sortable" data-column="cityZh">ä¸­æ–‡åŸå¸‚åç¨±</th>
                        <th class="sortable" data-column="countryZh">ä¸­æ–‡åœ‹å®¶åç¨±</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                </tbody>
            </table>
        </div>

        <div class="stats" id="statsSection" style="display: none;">
            <div class="stat-item">
                <div class="stat-number" id="totalRecords">0</div>
                <div class="stat-label">ç¸½è¨˜éŒ„æ•¸</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-label">ä½¿ç”¨è€…æ•¸é‡</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalBreakfasts">0</div>
                <div class="stat-label">æ—©é¤ç…§ç‰‡æ•¸</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalCities">0</div>
                <div class="stat-label">ä¸åŒåŸå¸‚æ•¸</div>
            </div>
        </div>
    </div>

    <!-- åœ–ç‰‡å½ˆå‡ºçª—å£ -->
    <div id="imageModal" class="modal">
        <span class="modal-close" onclick="closeImageModal()">&times;</span>
        <div class="modal-content">
            <img id="modalImage" src="" alt="æ—©é¤ç…§ç‰‡">
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase é…ç½®
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getFirestore, collection, getDocs, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDNWIFLZRJOXPRR5H5PqHnqxBGZnz0_Q90",
            authDomain: "subjective-clock.firebaseapp.com",
            projectId: "subjective-clock",
            storageBucket: "subjective-clock.firebasestorage.app",
            messagingSenderId: "391886721399",
            appId: "1:391886721399:web:af5c55d3f3be5b6c51cc7d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // å…¨åŸŸè®Šæ•¸
        let allUserData = [];
        let filteredData = [];
        let currentSort = { column: null, direction: 'asc' };

        // è¼‰å…¥æ‰€æœ‰ä½¿ç”¨è€…è³‡æ–™
        window.loadAllUserData = async function() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorMessage = document.getElementById('errorMessage');
            const tableContainer = document.getElementById('tableContainer');
            const statsSection = document.getElementById('statsSection');

            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            loadingIndicator.style.display = 'block';
            errorMessage.style.display = 'none';
            tableContainer.style.display = 'none';
            statsSection.style.display = 'none';

            try {
                console.log('é–‹å§‹è¼‰å…¥æ‰€æœ‰ä½¿ç”¨è€…è³‡æ–™...');
                allUserData = [];

                // æŸ¥è©¢ artifacts é›†åˆä¸‹çš„æ‰€æœ‰æ–‡æª”
                const artifactsCollection = collection(db, 'artifacts');
                const artifactsSnapshot = await getDocs(artifactsCollection);

                for (const artifactDoc of artifactsSnapshot.docs) {
                    const appId = artifactDoc.id;
                    console.log(`è™•ç†æ‡‰ç”¨ç¨‹å¼: ${appId}`);

                    // æŸ¥è©¢è©²æ‡‰ç”¨ç¨‹å¼ä¸‹çš„æ‰€æœ‰ä½¿ç”¨è€…
                    const userProfilesCollection = collection(db, `artifacts/${appId}/userProfiles`);
                    const userProfilesSnapshot = await getDocs(userProfilesCollection);

                    for (const userDoc of userProfilesSnapshot.docs) {
                        const userId = userDoc.id;
                        console.log(`è™•ç†ä½¿ç”¨è€…: ${userId}`);

                        // æŸ¥è©¢è©²ä½¿ç”¨è€…çš„æ‰€æœ‰ç”¦é†’è¨˜éŒ„
                        const clockHistoryCollection = collection(db, `artifacts/${appId}/userProfiles/${userId}/clockHistory`);
                        const clockHistoryQuery = query(clockHistoryCollection, orderBy('recordedAt', 'desc'));
                        const clockHistorySnapshot = await getDocs(clockHistoryQuery);

                        clockHistorySnapshot.forEach(recordDoc => {
                            const recordData = recordDoc.data();
                            const recordedAt = recordData.recordedAt ? recordData.recordedAt.toDate() : null;
                            
                            allUserData.push({
                                userId: userId,
                                appId: appId,
                                recordId: recordDoc.id,
                                date: recordedAt ? recordedAt.toLocaleDateString('zh-TW') : 'æœªçŸ¥',
                                time: recordedAt ? recordedAt.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' }) : 'æœªçŸ¥',
                                city: recordData.city || 'æœªçŸ¥',
                                country: recordData.country || 'æœªçŸ¥',
                                cityZh: recordData.city_zh || '',
                                countryZh: recordData.country_zh || '',
                                imageUrl: recordData.imageUrl || '',
                                recordedAt: recordedAt,
                                ...recordData
                            });
                        });
                    }
                }

                console.log(`è¼‰å…¥å®Œæˆï¼Œå…± ${allUserData.length} ç­†è¨˜éŒ„`);

                // åˆå§‹åŒ–é¡¯ç¤º
                filteredData = [...allUserData];
                renderTable();
                updateStats();

                // éš±è—è¼‰å…¥ç‹€æ…‹ï¼Œé¡¯ç¤ºè¡¨æ ¼
                loadingIndicator.style.display = 'none';
                tableContainer.style.display = 'block';
                statsSection.style.display = 'flex';

            } catch (error) {
                console.error('è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                loadingIndicator.style.display = 'none';
                errorMessage.textContent = `è¼‰å…¥å¤±æ•—: ${error.message}`;
                errorMessage.style.display = 'block';
            }
        };

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            const tableBody = document.getElementById('dataTableBody');
            tableBody.innerHTML = '';

            filteredData.forEach(record => {
                const row = document.createElement('tr');
                
                // æ—©é¤ç…§ç‰‡æ¬„ä½
                let breakfastCell = '';
                if (record.imageUrl) {
                    breakfastCell = `<img src="${record.imageUrl}" alt="æ—©é¤ç…§ç‰‡" class="breakfast-thumbnail" onclick="showImageModal('${record.imageUrl}')">`;
                } else {
                    breakfastCell = '<div class="no-image">ç„¡ç…§ç‰‡</div>';
                }

                // ç…§ç‰‡ç¶²å€æ¬„ä½
                let urlCell = '';
                if (record.imageUrl) {
                    urlCell = `<a href="${record.imageUrl}" target="_blank" class="url-link" title="${record.imageUrl}">${record.imageUrl}</a>`;
                } else {
                    urlCell = 'ç„¡';
                }

                row.innerHTML = `
                    <td class="user-id">${record.userId}</td>
                    <td class="date-time">${record.date}</td>
                    <td class="date-time">${record.time}</td>
                    <td class="city-name">${record.city}</td>
                    <td class="country-name">${record.country}</td>
                    <td>${breakfastCell}</td>
                    <td>${urlCell}</td>
                    <td class="city-name">${record.cityZh || 'ç„¡'}</td>
                    <td class="country-name">${record.countryZh || 'ç„¡'}</td>
                `;

                tableBody.appendChild(row);
            });
        }

        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStats() {
            const totalRecords = filteredData.length;
            const uniqueUsers = new Set(filteredData.map(record => record.userId)).size;
            const totalBreakfasts = filteredData.filter(record => record.imageUrl).length;
            const uniqueCities = new Set(filteredData.map(record => record.city)).size;

            document.getElementById('totalRecords').textContent = totalRecords;
            document.getElementById('totalUsers').textContent = uniqueUsers;
            document.getElementById('totalBreakfasts').textContent = totalBreakfasts;
            document.getElementById('totalCities').textContent = uniqueCities;
        }

        // æœå°‹åŠŸèƒ½
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            
            if (searchTerm === '') {
                filteredData = [...allUserData];
            } else {
                filteredData = allUserData.filter(record => 
                    record.userId.toLowerCase().includes(searchTerm) ||
                    record.city.toLowerCase().includes(searchTerm) ||
                    record.country.toLowerCase().includes(searchTerm) ||
                    (record.cityZh && record.cityZh.includes(searchTerm)) ||
                    (record.countryZh && record.countryZh.includes(searchTerm))
                );
            }
            
            renderTable();
            updateStats();
        });

        // æ’åºåŠŸèƒ½
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', function() {
                const column = this.dataset.column;
                
                // æ›´æ–°æ’åºç‹€æ…‹
                if (currentSort.column === column) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = column;
                    currentSort.direction = 'asc';
                }

                // æ›´æ–°è¡¨é ­æ¨£å¼
                document.querySelectorAll('.sortable').forEach(h => {
                    h.classList.remove('sort-asc', 'sort-desc');
                });
                this.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');

                // åŸ·è¡Œæ’åº
                filteredData.sort((a, b) => {
                    let valueA = a[column];
                    let valueB = b[column];

                    // ç‰¹æ®Šè™•ç†æ—¥æœŸæ™‚é–“æ’åº
                    if (column === 'date' || column === 'time') {
                        valueA = a.recordedAt || new Date(0);
                        valueB = b.recordedAt || new Date(0);
                    }

                    // å­—ä¸²æ¯”è¼ƒ
                    if (typeof valueA === 'string') {
                        valueA = valueA.toLowerCase();
                        valueB = valueB.toLowerCase();
                    }

                    if (currentSort.direction === 'asc') {
                        return valueA > valueB ? 1 : -1;
                    } else {
                        return valueA < valueB ? 1 : -1;
                    }
                });

                renderTable();
            });
        });

        // åœ–ç‰‡å½ˆå‡ºçª—å£
        window.showImageModal = function(imageUrl) {
            document.getElementById('modalImage').src = imageUrl;
            document.getElementById('imageModal').style.display = 'block';
        };

        window.closeImageModal = function() {
            document.getElementById('imageModal').style.display = 'none';
        };

        // é»æ“Šå½ˆå‡ºçª—å£å¤–éƒ¨é—œé–‰
        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageModal();
            }
        });

        // åŒ¯å‡º CSV åŠŸèƒ½
        window.exportToCSV = function() {
            if (filteredData.length === 0) {
                alert('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º');
                return;
            }

            const headers = ['ä½¿ç”¨è€…ä»£è™Ÿ', 'æ—¥æœŸ', 'æ™‚é–“', 'City', 'Country', 'ç…§ç‰‡ç¶²å€', 'ä¸­æ–‡åŸå¸‚åç¨±', 'ä¸­æ–‡åœ‹å®¶åç¨±'];
            const csvContent = [
                headers.join(','),
                ...filteredData.map(record => [
                    `"${record.userId}"`,
                    `"${record.date}"`,
                    `"${record.time}"`,
                    `"${record.city}"`,
                    `"${record.country}"`,
                    `"${record.imageUrl || ''}"`,
                    `"${record.cityZh || ''}"`,
                    `"${record.countryZh || ''}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `ä¸»è§€æ™‚é˜_ä½¿ç”¨è€…è³‡æ–™_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // é é¢è¼‰å…¥å®Œæˆå¾Œè‡ªå‹•è¼‰å…¥è³‡æ–™
        document.addEventListener('DOMContentLoaded', function() {
            loadAllUserData();
        });

        // ESC éµé—œé–‰å½ˆå‡ºçª—å£
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeImageModal();
            }
        });
    </script>
</body>
</html>
