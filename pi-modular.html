<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=800, initial-scale=1.0">
    <title>ç”¦é†’åœ°åœ– Raspberry Pi (æ¨¡çµ„åŒ–ç‰ˆæœ¬)</title>
    
    <!-- ç¶²é åœ–æ¨™è¨­å®š -->
    <link rel="icon" href="favicon.ico">
    <link rel="icon" href="favicon-16x16.png" sizes="16x16" type="image/png">
    <link rel="icon" href="favicon-32x32.png" sizes="32x32" type="image/png">
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <meta name="theme-color" content="#4d714f">
    
    <!-- Google Fonts - Pixel/Digital é¢¨æ ¼å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Orbitron:wght@400;700;900&family=VT323&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- è‡ªå®šç¾©åƒç´ å­—é«” -->
    <style>
        @font-face {
            font-family: 'ByteBounce';
            src: local('ByteBounce'), local('ByteBounce-Regular');
            font-display: swap;
        }
        
        @font-face {
            font-family: 'GB18030 Bitmap';
            src: local('GB18030 Bitmap'), local('GB18030Bitmap');
            font-display: swap;
        }
        
        /* å­—é«”å †ç–Šè¨­ç½® */
        .pixel-font-en {
            font-family: 'ByteBounce', 'Press Start 2P', 'Courier New', monospace;
        }
        
        .pixel-font-cn {
            font-family: 'GB18030 Bitmap', 'Microsoft YaHei', 'å¾®è»Ÿé›…é»‘', SimHei, 'é»‘é«”', sans-serif;
        }
        
        .pixel-font-mixed {
            font-family: 'ByteBounce', 'GB18030 Bitmap', 'Press Start 2P', 'Microsoft YaHei', 'å¾®è»Ÿé›…é»‘', monospace;
        }
    </style>
    
    <!-- ä¸»è¦æ¨£å¼è¡¨ -->
    <link rel="stylesheet" href="pi-style.css">
    
    <!-- Leaflet åœ°åœ–åº« CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
</head>
<body>
    <div class="container">
        <!-- ä¸»è¦é¡¯ç¤ºå€åŸŸ -->
        <main class="main-display">
            <!-- å…¨åŸŸèƒŒæ™¯åœ°åœ– -->
            <div id="mainMapContainer" class="main-map-background"></div>
            
            <!-- åœ°åœ–ç¸®æ”¾æ§åˆ¶æŒ‰éˆ• - çµ±ä¸€ä½ç½® -->
            <div class="map-zoom-controls">
                <button id="zoomInButton" class="zoom-button" title="æ”¾å¤§">+</button>
                <button id="zoomOutButton" class="zoom-button" title="ç¸®å°">-</button>
            </div>
            
            <!-- ğŸ”§ çµ„ä»¶å°‡åœ¨æ­¤è™•å‹•æ…‹è¼‰å…¥ -->
            <!-- waiting-state.html, loading-state.html, result-state.html -->
            
            <!-- éŒ¯èª¤ç‹€æ…‹ (ä¿ç•™åœ¨ä¸»æ–‡ä»¶ä¸­) -->
            <div id="errorState" class="error-state">
                <div class="error-content">
                    <div class="error-icon">âš ï¸</div>
                    <h2 class="error-text">æš«æ™‚ç„¡æ³•é€£æ¥</h2>
                    <p id="errorMessage" class="error-subtitle">è«‹ç¨å€™å†è©¦</p>
                </div>
            </div>
        </main>

        <!-- éš±è—å…ƒç´  (ç”¨æ–¼ä¿æŒç›¸å®¹æ€§) -->
        <div style="display: none;">
            <input type="hidden" id="groupName" value="">
            <input type="hidden" id="userName" value="future">
            
            <!-- è™›æ“¬æŒ‰éˆ•å…ƒç´ ï¼Œä¾›åŸæœ‰ JavaScript ç›¸å®¹ -->
            <button id="setUserNameButton" class="load-button">è¼‰å…¥è³‡æ–™</button>
            <button id="findCityButton" class="start-button">é–‹å§‹é€™ä¸€å¤©</button>
            
            <!-- ç›¸å®¹æ€§å…ƒç´  -->
            <div id="resultText" class="result-text"></div>
            <div id="debugInfo" class="debug-info"></div>
            <div id="debugInfoSmall" class="debug-info-small"></div>
            <div id="currentUserId">future</div>
            <div id="currentUserDisplayName">future</div>
            
            <!-- åˆ†é ç›¸é—œéš±è—å…ƒç´  -->
            <ul id="historyList"></ul>
            <div id="historyMapContainer"></div>
            <div id="historyDebugInfo"></div>
            <button id="refreshHistoryButton"></button>
            <input type="date" id="globalDate">
            <select id="groupFilter"><option value="all">æ‰€æœ‰äºº</option></select>
            <button id="refreshGlobalMapButton"></button>
            <div id="globalTodayMapContainer"></div>
            <div id="globalTodayDebugInfo"></div>
        </div>
    </div>

    <!-- è¼‰å…¥å½ˆè·³å¼æ—¥èªŒè¦–çª— -->
    <div id="historyLogModal" class="modal" style="display:none;">
        <div class="modal-dialog">
            <div class="modal-content-wrapper">
                <div class="modal-header">
                    <h2 id="modalTitle">ç”¦é†’æ—¥èªŒè©³æƒ…</h2>
                    <span id="historyLogModalClose" class="modal-close-button">&times;</span>
                </div>
                <div id="historyLogModalContent" class="modal-body"></div>
                <div class="modal-footer">
                    <button id="closeModalFooterButton" class="modal-button-secondary">é—œé–‰</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ“¦ 1. é¦–å…ˆè¼‰å…¥çµ„ä»¶è¼‰å…¥å™¨ -->
    <script src="components/component-loader.js"></script>

    <!-- ğŸ”¥ 2. è¼‰å…¥ Firebase é…ç½® -->
    <script src="/api/config"></script>

    <!-- ğŸ”¥ 3. è¼‰å…¥ Firebase SDK ä¸¦åˆå§‹åŒ– -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js';
        import { 
            getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken
        } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js';
        import { 
            getFirestore, collection, addDoc, query, where, getDocs, orderBy, 
            serverTimestamp, doc, setDoc, getDoc, limit, updateDoc, setLogLevel
        } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js';

        // ç­‰å¾… Firebase é…ç½®è¼‰å…¥
        function initializeFirebase() {
            if (window.firebaseConfig) {
                try {
                    console.log('ğŸ”¥ é–‹å§‹åˆå§‹åŒ– Firebase...');
                    const app = initializeApp(window.firebaseConfig);
                    
                    // æ‰“åŒ…æ‰€æœ‰ Firebase åŠŸèƒ½ä¾›ä¸»è…³æœ¬ä½¿ç”¨
                    window.firebaseSDK = {
                        initializeApp,
                        getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
                        getFirestore, collection, addDoc, query, where, getDocs, orderBy, 
                        serverTimestamp, doc, setDoc, getDoc, limit, updateDoc, setLogLevel
                    };
                    
                    console.log('âœ… Firebase SDK å·²æº–å‚™å°±ç·’');
                    
                    // ç™¼é€ Firebase å°±ç·’äº‹ä»¶
                    window.dispatchEvent(new CustomEvent('firebaseReady'));
                } catch (error) {
                    console.error('âŒ Firebase åˆå§‹åŒ–å¤±æ•—:', error);
                    // å³ä½¿å¤±æ•—ä¹Ÿè¦è¨­ç½®åŸºæœ¬çš„ SDK
                    window.firebaseSDK = {
                        initializeApp,
                        getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
                        getFirestore, collection, addDoc, query, where, getDocs, orderBy, 
                        serverTimestamp, doc, setDoc, getDoc, limit, updateDoc, setLogLevel
                    };
                }
            } else {
                console.warn('âš ï¸ Firebase é…ç½®å°šæœªè¼‰å…¥ï¼Œ2ç§’å¾Œé‡è©¦...');
                setTimeout(initializeFirebase, 2000);
            }
        }

        // é–‹å§‹åˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeFirebase);
        } else {
            initializeFirebase();
        }
    </script>

    <!-- ğŸ—ºï¸ 4. è¼‰å…¥ Leaflet åœ°åœ–åº« -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <!-- ğŸš€ 5. è¼‰å…¥é‡æ§‹ç‰ˆä¸»è¦æ‡‰ç”¨ç¨‹å¼è…³æœ¬ -->
    <script src="pi-script-refactored.js"></script>
    
    <!-- ğŸ”§ 6. æ¨¡çµ„åŒ–åˆå§‹åŒ–è…³æœ¬ -->
    <script>
        // ğŸ—ºï¸ åœ°åœ–åˆå§‹åŒ–åŠŸèƒ½
        function initializeMap() {
            const mapContainer = document.getElementById('mainMapContainer');
            if (!mapContainer) {
                console.warn('âš ï¸ åœ°åœ–å®¹å™¨å…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“åˆå§‹åŒ–é
            if (window.mainInteractiveMap) {
                console.log('ğŸ—ºï¸ åœ°åœ–å·²ç¶“åˆå§‹åŒ–ï¼Œè·³éé‡è¤‡åˆå§‹åŒ–');
                return;
            }
            
            // æª¢æŸ¥å®¹å™¨æ˜¯å¦å·²ç¶“è¢« Leaflet ä½¿ç”¨
            if (mapContainer._leaflet_id) {
                console.log('ğŸ—ºï¸ åœ°åœ–å®¹å™¨å·²è¢«ä½¿ç”¨ï¼Œæ¸…ç†å¾Œé‡æ–°åˆå§‹åŒ–');
                mapContainer._leaflet_id = null;
                mapContainer.innerHTML = '';
            }
            
            try {
                const latitude = window.currentLatitude || 25.0330;
                const longitude = window.currentLongitude || 121.5654;
                
                window.mainInteractiveMap = L.map('mainMapContainer').setView([latitude, longitude], 3);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 18,
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(window.mainInteractiveMap);
                
                console.log('âœ… åœ°åœ–åˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('âŒ åœ°åœ–åˆå§‹åŒ–å¤±æ•—:', error);
                // å¦‚æœå¤±æ•—ï¼Œæ¸…ç†å®¹å™¨ç‹€æ…‹
                if (mapContainer._leaflet_id) {
                    mapContainer._leaflet_id = null;
                    mapContainer.innerHTML = '';
                }
            }
        }
        
        // ğŸ”§ ç¢ºä¿åœ°åœ–åœ¨é é¢è¼‰å…¥å¾Œåˆå§‹åŒ–
        function ensureMapInitialized() {
            if (typeof L !== 'undefined' && !window.mainInteractiveMap) {
                initializeMap();
            } else if (typeof L === 'undefined') {
                console.warn('âš ï¸ Leaflet å°šæœªè¼‰å…¥ï¼Œç¨å¾Œé‡è©¦...');
                setTimeout(ensureMapInitialized, 1000);
            }
        }
        
        // ğŸ“¦ ç›£è½çµ„ä»¶è¼‰å…¥å®Œæˆäº‹ä»¶
        document.addEventListener('allComponentsReady', function() {
            console.log('ğŸ‰ æ‰€æœ‰çµ„ä»¶å·²è¼‰å…¥å®Œæˆ');
            
            // ç¢ºä¿åœ°åœ–åˆå§‹åŒ–
            setTimeout(ensureMapInitialized, 1000);
            
            // ç¢ºä¿å„ç¨®ç®¡ç†å™¨å·²æº–å‚™å°±ç·’
            if (window.resultStateManager) {
                console.log('ğŸ“Š çµæœç‹€æ…‹ç®¡ç†å™¨å·²å°±ç·’');
            }
            
            if (window.loadingStateManager) {
                console.log('â³ è¼‰å…¥ç‹€æ…‹ç®¡ç†å™¨å·²å°±ç·’');
            }
        });
        
        // âŒ¨ï¸ éš±è—æŒ‰éˆ•å¿«æ·éµåŠŸèƒ½
        document.addEventListener('keydown', function(event) {
            // Ctrl + H è§¸ç™¼éš±è—æŒ‰éˆ•
            if (event.ctrlKey && event.key === 'h') {
                event.preventDefault();
                console.log('ğŸ”§ éš±è—å¿«æ·éµ Ctrl+H è¢«è§¸ç™¼');
                if (window.startTheDay && typeof window.startTheDay === 'function') {
                    window.startTheDay();
                } else {
                    console.warn('âš ï¸ startTheDay å‡½æ•¸å°šæœªæº–å‚™å°±ç·’');
                }
            }
            
            // ESC éµé¡¯ç¤º/éš±è—ç·Šæ€¥æŒ‰éˆ•
            if (event.key === 'Escape') {
                const hiddenButton = document.getElementById('hiddenBackupButton');
                if (hiddenButton) {
                    if (hiddenButton.style.opacity === '0.02' || hiddenButton.style.opacity === '') {
                        hiddenButton.style.opacity = '0.3';
                        hiddenButton.style.background = 'rgba(255, 100, 100, 0.3)';
                        console.log('ğŸ†˜ ç·Šæ€¥æŒ‰éˆ•å·²é¡¯ç¤º (å·¦ä¸Šè§’)');
                        setTimeout(() => {
                            hiddenButton.style.opacity = '0.02';
                            hiddenButton.style.background = 'rgba(255, 255, 255, 0.02)';
                        }, 5000); // 5ç§’å¾Œè‡ªå‹•éš±è—
                    }
                }
            }
        });
        
        // ğŸ”§ éš±è—æŒ‰éˆ•èª¿è©¦åŠŸèƒ½ (é–‹ç™¼è€…æ§åˆ¶å°ä½¿ç”¨)
        window.hiddenButtonControl = {
            show: function() {
                const button = document.getElementById('hiddenBackupButton');
                if (button) {
                    button.style.opacity = '0.8';
                    button.style.background = 'rgba(77, 113, 79, 0.8)';
                    button.style.border = '2px solid #4d714f';
                    console.log('ğŸ”§ éš±è—æŒ‰éˆ•å·²å¼·åˆ¶é¡¯ç¤º');
                }
            },
            hide: function() {
                const button = document.getElementById('hiddenBackupButton');
                if (button) {
                    button.style.opacity = '0.02';
                    button.style.background = 'rgba(255, 255, 255, 0.02)';
                    button.style.border = '1px solid rgba(255, 255, 255, 0.05)';
                    console.log('ğŸ”§ éš±è—æŒ‰éˆ•å·²é‡æ–°éš±è—');
                }
            },
            trigger: function() {
                console.log('ğŸ”§ é€éèª¿è©¦åŠŸèƒ½è§¸ç™¼éš±è—æŒ‰éˆ•');
                if (window.startTheDay && typeof window.startTheDay === 'function') {
                    window.startTheDay();
                } else {
                    console.warn('âš ï¸ startTheDay å‡½æ•¸å°šæœªæº–å‚™å°±ç·’');
                }
            },
            help: function() {
                console.log(`
ğŸ”§ éš±è—æŒ‰éˆ•æ§åˆ¶æŒ‡ä»¤ï¼š
- hiddenButtonControl.show()    : é¡¯ç¤ºéš±è—æŒ‰éˆ• (å·¦ä¸Šè§’)
- hiddenButtonControl.hide()    : éš±è—æŒ‰éˆ•
- hiddenButtonControl.trigger() : è§¸ç™¼æŒ‰éˆ•åŠŸèƒ½
- Ctrl + H                      : éµç›¤å¿«æ·éµè§¸ç™¼
- ESC                          : è‡¨æ™‚é¡¯ç¤ºç·Šæ€¥æŒ‰éˆ• (5ç§’ï¼Œå·¦ä¸Šè§’)
                `);
            }
        };
        
        // åœ¨æ§åˆ¶å°é¡¯ç¤ºæ¨¡çµ„åŒ–ç‰ˆæœ¬è³‡è¨Š
        console.log(`
ğŸ‰ ç”¦é†’åœ°åœ– Raspberry Pi (æ¨¡çµ„åŒ–ç‰ˆæœ¬) å·²è¼‰å…¥
ğŸ“¦ çµ„ä»¶åŒ–çµæ§‹: waiting-state.html + loading-state.html + result-state.html
ğŸš€ ä¸»è¦è…³æœ¬: pi-script-refactored.js
ğŸ”§ è¼¸å…¥ hiddenButtonControl.help() æŸ¥çœ‹éš±è—åŠŸèƒ½èªªæ˜
        `);
    </script>
</body>
</html>