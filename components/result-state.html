<!-- üìä Result È†ÅÈù¢ÁµÑ‰ª∂ -->
<!-- ÁµêÊûúÁãÄÊÖã - È°ØÁ§∫ÂüéÂ∏ÇË≥áË®ä„ÄÅÂú∞ÂúñËªåË∑°ÂíåÂâµÊÑèÊïÖ‰∫ã -->
<div id="resultState" class="state result-state">
    <!-- Â∑¶ÂÅ¥‰ø°ÊÅØÈù¢Êùø (ÊµÆÂ±§) -->
    <div class="result-info-panel">
        <!-- Êó•Êúü‰ø°ÊÅØÂçÄÂüü -->
        <div class="date-info">
            <span class="date-label">Date:</span>
            <span id="wakeupDate" class="date-value">07/25/2025 Fri</span>
        </div>
        
        <!-- ÂïèÂÄôË™û‰ø°ÊÅØÂçÄÂüü -->
        <div class="greeting-info">
            <span id="localGreeting" class="local-greeting">GOOD MORNING! (English)</span>
        </div>
        
        <!-- Âú∞Èªû‰ø°ÊÅØÂçÄÂüü -->
        <div class="location-info">
            <!-- ÂüéÂ∏ÇÂêçÁ®± -->
            <h1 id="cityName" class="city-name">LOGAN</h1>
            
            <!-- ÂúãÂÆ∂‰ø°ÊÅØ -->
            <div class="country-info">
                <img id="countryFlag" class="country-flag" src="" alt="Flag" onerror="this.style.display='none'">
                <span id="countryName" class="country-name">United States</span>
            </div>
            
            <!-- Â∫ßÊ®ô‰ø°ÊÅØ -->
            <div class="coordinates-info">
                <span class="coordinates-label">Coordinates:</span>
                <span id="coordinates" class="coordinates-text">21.276, 55.517</span>
            </div>
        </div>
        
        <!-- ÊïÖ‰∫ãÊñáÂ≠óÂÆπÂô® -->
        <div class="story-container">
            <div class="story-header">
                <span class="story-label">‰ªäÊó•ÊïÖ‰∫ã</span>
                <div class="story-status">
                    <span id="storyStatusIndicator" class="status-indicator">‚è≥</span>
                </div>
            </div>
            <p id="storyText" class="story-text">ËºâÂÖ•‰∏≠...</p>
        </div>
    </div>
</div>

<!-- ÁµêÊûúÁãÄÊÖãÂ∞àÁî®Ê®£Âºè -->
<style>
    /* ÁµêÊûúÁãÄÊÖãÂÆπÂô® */
    .result-state {
        position: relative;
        width: 100%;
        height: 100%;
    }
    
    /* ÁµêÊûú‰ø°ÊÅØÈù¢Êùø */
    .result-info-panel {
        position: absolute;
        top: 20px;
        left: 20px;
        width: 350px;
        max-height: calc(100vh - 40px);
        background: rgba(0, 0, 0, 0.85);
        border: 2px solid rgba(77, 113, 79, 0.6);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(15px);
        z-index: 1000;
        overflow-y: auto;
        animation: slideInLeft 0.8s ease-out;
    }
    
    @keyframes slideInLeft {
        0% {
            transform: translateX(-100%);
            opacity: 0;
        }
        100% {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    /* Êó•Êúü‰ø°ÊÅØ */
    .date-info {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(77, 113, 79, 0.3);
    }
    
    .date-label {
        font-family: 'Orbitron', monospace;
        font-size: 12px;
        color: #a8e6cf;
        margin-right: 8px;
    }
    
    .date-value {
        font-family: 'Press Start 2P', monospace;
        font-size: 14px;
        color: #4ecdc4;
        text-shadow: 0 0 5px rgba(78, 205, 196, 0.3);
    }
    
    /* ÂïèÂÄôË™û‰ø°ÊÅØ */
    .greeting-info {
        margin-bottom: 25px;
    }
    
    .local-greeting {
        font-family: 'ByteBounce', 'Press Start 2P', monospace;
        font-size: 16px;
        color: #ffc107;
        text-shadow: 0 0 8px rgba(255, 193, 7, 0.4);
        display: block;
        line-height: 1.4;
    }
    
    /* Âú∞Èªû‰ø°ÊÅØ */
    .location-info {
        margin-bottom: 25px;
    }
    
    .city-name {
        font-family: 'Press Start 2P', 'ByteBounce', monospace;
        font-size: 24px;
        color: #4d714f;
        margin: 0 0 15px 0;
        text-shadow: 0 0 10px rgba(77, 113, 79, 0.5);
        word-break: break-word;
    }
    
    .country-info {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        gap: 10px;
    }
    
    .country-flag {
        width: 24px;
        height: 16px;
        object-fit: cover;
        border-radius: 2px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .country-name {
        font-family: 'Orbitron', monospace;
        font-size: 16px;
        color: #c8e6c9;
    }
    
    .coordinates-info {
        margin-top: 10px;
    }
    
    .coordinates-label {
        font-family: 'Orbitron', monospace;
        font-size: 11px;
        color: #a8e6cf;
        display: block;
        margin-bottom: 5px;
    }
    
    .coordinates-text {
        font-family: 'VT323', monospace;
        font-size: 14px;
        color: #81c784;
        background: rgba(77, 113, 79, 0.2);
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid rgba(77, 113, 79, 0.3);
    }
    
    /* ÊïÖ‰∫ãÂÆπÂô® */
    .story-container {
        border-top: 1px solid rgba(77, 113, 79, 0.3);
        padding-top: 20px;
    }
    
    .story-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .story-label {
        font-family: 'GB18030 Bitmap', 'Microsoft YaHei', sans-serif;
        font-size: 14px;
        color: #a8e6cf;
        font-weight: bold;
    }
    
    .story-status {
        display: flex;
        align-items: center;
    }
    
    .status-indicator {
        font-size: 12px;
        margin-left: 5px;
    }
    
    .status-indicator.loading {
        color: #ffc107;
        animation: spin 2s linear infinite;
    }
    
    .status-indicator.ready {
        color: #4caf50;
    }
    
    .status-indicator.error {
        color: #f44336;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .story-text {
        font-family: 'GB18030 Bitmap', 'Microsoft YaHei', sans-serif;
        font-size: 16px;
        color: #e8f5e8;
        line-height: 1.6;
        margin: 0;
        background: rgba(77, 113, 79, 0.1);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid rgba(77, 113, 79, 0.2);
        min-height: 100px;
        word-wrap: break-word;
    }
    
    /* ÊâìÂ≠óÊ©üÊïàÊûú */
    .story-text.typing {
        border-right: 2px solid #4d714f;
        animation: blink 1s infinite;
    }
    
    @keyframes blink {
        0%, 50% { border-color: #4d714f; }
        51%, 100% { border-color: transparent; }
    }
    
    /* ÈüøÊáâÂºèË®≠Ë®à */
    @media (max-width: 480px) {
        .result-info-panel {
            width: calc(100% - 40px);
            max-width: 350px;
        }
        
        .city-name {
            font-size: 20px;
        }
        
        .story-text {
            font-size: 14px;
        }
    }
    
    /* ÊªæÂãïÊ¢ùÁæéÂåñ */
    .result-info-panel::-webkit-scrollbar {
        width: 8px;
    }
    
    .result-info-panel::-webkit-scrollbar-track {
        background: rgba(77, 113, 79, 0.1);
        border-radius: 4px;
    }
    
    .result-info-panel::-webkit-scrollbar-thumb {
        background: rgba(77, 113, 79, 0.5);
        border-radius: 4px;
    }
    
    .result-info-panel::-webkit-scrollbar-thumb:hover {
        background: rgba(77, 113, 79, 0.7);
    }
</style>

<!-- ÁµêÊûúÁãÄÊÖãÂ∞àÁî®ËÖ≥Êú¨ -->
<script>
    // ÁµêÊûúÁãÄÊÖãÁÆ°ÁêÜ
    class ResultStateManager {
        constructor() {
            this.typewriterActive = false;
            this.typewriterInterval = null;
        }
        
        init() {
            console.log('üìä ÁµêÊûúÁãÄÊÖãÁµÑ‰ª∂Â∑≤ËºâÂÖ•');
            this.setupCityNameObserver();
            this.setupStoryStatusIndicator();
        }
        
        // Áõ£ËÅΩÂüéÂ∏ÇÂêçÁ®±ËÆäÂåñÔºåËá™ÂãïÊ∑ªÂä†ÂÜíËôü
        setupCityNameObserver() {
            const cityElement = document.getElementById('cityName');
            if (!cityElement) return;
            
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList' || mutation.type === 'characterData') {
                        const cityName = cityElement.textContent.trim();
                        if (cityName && !cityName.endsWith(':')) {
                            cityElement.textContent = cityName.toUpperCase() + ':';
                        }
                    }
                });
            });
            
            observer.observe(cityElement, {
                childList: true,
                characterData: true,
                subtree: true
            });
            
            console.log('üèôÔ∏è ÂüéÂ∏ÇÂêçÁ®±ËßÄÂØüÂô®Â∑≤ÂïüÂãï');
        }
        
        // Ë®≠ÁΩÆÊïÖ‰∫ãÁãÄÊÖãÊåáÁ§∫Âô®
        setupStoryStatusIndicator() {
            const indicator = document.getElementById('storyStatusIndicator');
            if (indicator) {
                this.setStoryStatus('loading');
            }
        }
        
        // Ë®≠ÁΩÆÊïÖ‰∫ãÁãÄÊÖã
        setStoryStatus(status) {
            const indicator = document.getElementById('storyStatusIndicator');
            if (!indicator) return;
            
            // Ê∏ÖÈô§ÊâÄÊúâÁãÄÊÖãÈ°û
            indicator.className = 'status-indicator';
            
            switch (status) {
                case 'loading':
                    indicator.classList.add('loading');
                    indicator.textContent = '‚è≥';
                    indicator.title = 'ÊïÖ‰∫ãÁîüÊàê‰∏≠...';
                    break;
                case 'ready':
                    indicator.classList.add('ready');
                    indicator.textContent = '‚úì';
                    indicator.title = 'ÊïÖ‰∫ãÂ∑≤ËºâÂÖ•';
                    break;
                case 'error':
                    indicator.classList.add('error');
                    indicator.textContent = '‚ö†';
                    indicator.title = 'ÊïÖ‰∫ãËºâÂÖ•Â§±Êïó';
                    break;
            }
        }
        
        // Êõ¥Êñ∞ÁµêÊûúÊï∏Êìö
        updateResultData(cityData) {
            console.log('üîÑ Êõ¥Êñ∞ÁµêÊûúÊï∏Êìö:', cityData);
            
            // Êõ¥Êñ∞Êó•Êúü
            const dateElement = document.getElementById('wakeupDate');
            if (dateElement) {
                const now = new Date();
                const options = {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    weekday: 'short'
                };
                dateElement.textContent = now.toLocaleDateString('en-US', options).replace(/\//g, '/');
            }
            
            // Êõ¥Êñ∞ÂüéÂ∏ÇÂêçÁ®±
            const cityElement = document.getElementById('cityName');
            if (cityElement && cityData.name) {
                cityElement.textContent = cityData.name.toUpperCase() + ':';
            }
            
            // Êõ¥Êñ∞ÂúãÂÆ∂‰ø°ÊÅØ
            const countryElement = document.getElementById('countryName');
            if (countryElement && cityData.country) {
                countryElement.textContent = cityData.country;
            }
            
            // Êõ¥Êñ∞ÂúãÊóó (Â¶ÇÊûúÊúâÂúãÂÆ∂‰ª£Á¢º)
            const flagElement = document.getElementById('countryFlag');
            if (flagElement && cityData.country_iso_code) {
                flagElement.src = `https://flagcdn.com/24x18/${cityData.country_iso_code.toLowerCase()}.png`;
                flagElement.style.display = 'block';
            }
            
            // Êõ¥Êñ∞Â∫ßÊ®ô
            const coordsElement = document.getElementById('coordinates');
            if (coordsElement && cityData.latitude && cityData.longitude) {
                const lat = parseFloat(cityData.latitude).toFixed(3);
                const lng = parseFloat(cityData.longitude).toFixed(3);
                coordsElement.textContent = `${lat}, ${lng}`;
            }
        }
        
        // È°ØÁ§∫ÊïÖ‰∫ãÊñáÂ≠ó (ÊâìÂ≠óÊ©üÊïàÊûú)
        displayStoryWithTypewriter(storyText, speed = 80) {
            const storyElement = document.getElementById('storyText');
            if (!storyElement || !storyText) return;
            
            // Ê∏ÖÈô§‰ªª‰ΩïÁèæÊúâÁöÑÊâìÂ≠óÊ©üÊïàÊûú
            this.stopTypewriter();
            
            // Ë®≠ÁΩÆÂàùÂßãÁãÄÊÖã
            storyElement.textContent = '';
            storyElement.classList.add('typing');
            this.typewriterActive = true;
            this.setStoryStatus('ready');
            
            let index = 0;
            this.typewriterInterval = setInterval(() => {
                if (index < storyText.length) {
                    storyElement.textContent += storyText[index];
                    index++;
                } else {
                    // ÊâìÂ≠óÂÆåÊàê
                    this.stopTypewriter();
                }
            }, speed);
            
            console.log('‚å®Ô∏è ÊïÖ‰∫ãÊâìÂ≠óÊ©üÊïàÊûúÂ∑≤ÂïüÂãï');
        }
        
        // ÂÅúÊ≠¢ÊâìÂ≠óÊ©üÊïàÊûú
        stopTypewriter() {
            if (this.typewriterInterval) {
                clearInterval(this.typewriterInterval);
                this.typewriterInterval = null;
            }
            
            const storyElement = document.getElementById('storyText');
            if (storyElement) {
                storyElement.classList.remove('typing');
            }
            
            this.typewriterActive = false;
        }
        
        // Ë®≠ÁΩÆÊïÖ‰∫ãÊñáÂ≠ó (ÁÑ°ÊâìÂ≠óÊïàÊûú)
        setStoryText(storyText) {
            const storyElement = document.getElementById('storyText');
            if (storyElement) {
                this.stopTypewriter();
                storyElement.textContent = storyText || 'Êö´ÁÑ°ÊïÖ‰∫ãÂÖßÂÆπ';
                this.setStoryStatus(storyText ? 'ready' : 'error');
            }
        }
        
        // Ê∏ÖÁêÜË≥áÊ∫ê
        cleanup() {
            this.stopTypewriter();
        }
    }
    
    // ÂÖ®ÂüüÁµêÊûúÁãÄÊÖãÁÆ°ÁêÜÂô®
    window.resultStateManager = new ResultStateManager();
    
    // ÁµÑ‰ª∂ËºâÂÖ•ÂÆåÊàêÂæåÂàùÂßãÂåñ
    document.addEventListener('DOMContentLoaded', function() {
        window.resultStateManager.init();
    });
    
    // Â¶ÇÊûúÂ∑≤Á∂ìËºâÂÖ•ÂÆåÊàêÔºåÁ´ãÂç≥ÂàùÂßãÂåñ
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        window.resultStateManager.init();
    }
    
    // Áõ£ËÅΩÊïÖ‰∫ãÁõ∏Èóú‰∫ã‰ª∂
    document.addEventListener('storyReady', function(event) {
        if (event.detail && event.detail.story) {
            console.log('üìñ Êî∂Âà∞ÊïÖ‰∫ãÂÖßÂÆπÔºåÈñãÂßãÊâìÂ≠óÊ©üÊïàÊûú');
            window.resultStateManager.displayStoryWithTypewriter(event.detail.story);
        }
    });
    
    // Áõ£ËÅΩÁµêÊûúÊï∏ÊìöÊõ¥Êñ∞‰∫ã‰ª∂
    document.addEventListener('resultDataUpdate', function(event) {
        if (event.detail && event.detail.cityData) {
            console.log('üîÑ Êî∂Âà∞ÁµêÊûúÊï∏ÊìöÊõ¥Êñ∞');
            window.resultStateManager.updateResultData(event.detail.cityData);
        }
    });
</script>