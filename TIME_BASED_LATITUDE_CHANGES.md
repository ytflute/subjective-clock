# 基於時間的緯度映射系統

## 概述
用戶按下「開始這一天」按鈕時，系統會基於當前時間來決定目標位置：
- **7:50-8:10**: 特例時間段，直接使用用戶當地位置
- **其他時間**: 基於分鐘數線性映射目標緯度

## 特例時間段：7:50-8:10

### 設計理念
在7:50-8:10這20分鐘的時間段內，系統不使用緯度計算公式，而是直接獲取用戶的當地位置來尋找甦醒城市。

### 邏輯說明
- **時間範圍**: 7:50:00 到 8:10:59
- **行為**: 獲取用戶當前地理位置，在用戶當地地區尋找城市
- **例子**: 
  - 用戶在臺灣8:00按下按鈕 → 直接尋找臺灣城市
  - 用戶在日本8:00按下按鈕 → 直接尋找日本城市

### 技術實現
- **網頁版**: 使用 `navigator.geolocation.getCurrentPosition()` 獲取用戶位置
- **樹莓派版**: 使用IP地理定位API獲取大概位置
- **後端**: 接收 `useLocalPosition`, `userLatitude`, `userLongitude` 參數

## 正常時間段：基於緯度映射

### 緯度映射公式（修正版）
```javascript
const targetLatitude = 70 - (minutes * 140 / 59);
```

### 完整時間映射表

| 時間 | 分鐘數 | 目標緯度 | 地理區域 | 說明 |
|------|--------|----------|----------|------|
| 7:50 | 50     | **特例** | 用戶當地 | 直接使用用戶位置 |
| 7:55 | 55     | **特例** | 用戶當地 | 直接使用用戶位置 |
| 8:00 | 0      | **特例** | 用戶當地 | 直接使用用戶位置 |
| 8:05 | 5      | **特例** | 用戶當地 | 直接使用用戶位置 |
| 8:10 | 10     | **特例** | 用戶當地 | 直接使用用戶位置 |
| 8:15 | 15     | 34.2°N   | 洛杉磯/東京 | 使用緯度公式 |
| 8:20 | 20     | 22.3°N   | 墨西哥/印度 | 使用緯度公式 |
| 8:25 | 25     | 10.4°N   | 委內瑞拉/菲律賓 | 使用緯度公式 |
| 8:30 | 30     | -1.5°S   | 赤道附近 | 使用緯度公式 |
| 8:35 | 35     | -13.4°S  | 秘魯/澳洲北部 | 使用緯度公式 |
| 8:40 | 40     | -25.4°S  | 巴西/南非 | 使用緯度公式 |
| 8:45 | 45     | -37.3°S  | 阿根廷/澳洲南部 | 使用緯度公式 |
| 8:50 | 50     | -49.2°S  | 巴塔哥尼亞 | 使用緯度公式 |
| 8:55 | 55     | -61.2°S  | 南極洲邊緣 | 使用緯度公式 |
| 8:59 | 59     | -70.0°S  | 南極洲 | 使用緯度公式 |

**修正原因：** 原始公式在0分和59分時會指向極地（±90°），極地地區沒有人口稠密的城市，導致API搜索時間過長或無結果。新公式避免了極地問題，確保所有時間點都能找到合適的城市。

### 系統流程

#### 特例時間段流程
1. 檢查當前時間是否在7:50-8:10之間
2. 如果是，獲取用戶地理位置（網頁版使用GPS，樹莓派版使用IP定位）
3. 在用戶當地地區尋找城市

#### 正常時間段流程
1. `calculateTargetLatitudeFromTime()`: 基於當前時間分鐘數計算目標緯度
2. **find-city-geonames API**: 接收 `targetLatitude` 參數
3. **緯度距離計算**: 計算所有候選城市與目標緯度的距離
4. **智能選擇**: 優先考慮時區匹配，然後選擇緯度最接近的城市

## 技術優勢

### 1. 用戶體驗提升
- 7:50-8:10期間提供本地化體驗
- 解決了8:00時的極地搜索問題

### 2. 精確性
- 直接基於數值緯度，不是模糊的分類
- 每分鐘約3度的緯度變化，提供細膩的變化

### 3. 全球覆蓋
- 真正涵蓋從北極到南極的完整緯度範圍
- 自動處理南北半球切換

### 4. 時間敏感性
- 每分鐘產生不同結果
- 30分鐘為赤道分界點，符合直覺

## 實際影響範例

### 特例時間段 (7:50-8:10)
- **臺灣用戶8:00**: 直接找臺灣城市如臺北、高雄等
- **日本用戶8:00**: 直接找日本城市如東京、大阪等
- **美國用戶8:00**: 直接找美國城市如紐約、洛杉磯等

### 正常時間段：北半球時段 (0-29分) - 修正後
- **8分**: 目標北緯51.1° → 可能選到倫敦、基輔、哈爾濱
- **15分**: 目標北緯34.4° → 可能選到洛杉磯、東京、首爾  
- **29分**: 目標北緯1.2° → 可能選到新加坡、吉隆坡

### 正常時間段：南半球時段 (30-59分) - 修正後
- **35分**: 目標南緯11.9° → 可能選到達爾文、雅加達南部
- **45分**: 目標南緯36.8° → 可能選到墨爾本、布宜諾斯艾利斯
- **55分**: 目標南緯58.1° → 可能選到福克蘭群島、南喬治亞島

## 備用機制
1. **特例時間段**: 如果地理位置獲取失敗，使用赤道附近（0°）作為備用
2. **正常時間段**: 修正後的緯度範圍（±70°）確保了所有時間點都能找到合適的城市
3. 如果仍然沒有找到完全匹配的城市，系統會：
   - 在所有候選時區城市中選擇緯度最接近的
   - 如果仍無合適城市，觸發「宇宙模式」

## 用戶體驗
- 視覺提示顯示實際目標緯度和地理區域描述
- 特例時間段會顯示「正在獲取地理位置」提示
- 日誌記錄包含完整的緯度映射資訊
- 向後兼容舊的緯度偏好分類系統

## 測試建議

### 特例時間段測試
1. 在7:50-8:10期間測試地理位置獲取
2. 確認返回的城市在用戶當地地區
3. 測試地理位置獲取失敗時的備用方案

### 正常時間段測試
1. 在不同分鐘數測試緯度計算
2. 確認能找到對應地區的城市
3. 確認沒有極地城市搜索問題 