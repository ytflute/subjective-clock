# 甦醒地圖 Wake Up Map

一個基於時間和緯度偏好的全球城市探索系統，讓你每次按下按鈕都能在地球上的不同角落「甦醒」。

## 📋 版本資訊

**當前版本：v4.0.0 - 完整軌跡視覺化版** *(2025年8月)*

🗺️ **重大功能更新：歷史軌跡自動顯示系統**
- **自動軌跡繪製**：按按鈕後自動顯示完整歷史路徑和標記
- **美化視覺效果**：歷史點漸變透明度，最新位置突出顯示
- **智能線條樣式**：灰色虛線連接歷史，紅色實線指向今日
- **語音故事保護**：完美解決語音內容被覆蓋的時序問題

🎨 **視覺體驗升級：**
- **歷史標記**：藍色圓點，距離越遠透明度越高（0.1-0.8）
- **軌跡線條**：灰色虛線(#999999)，簡潔不突兀
- **今日位置**：紅色標記(#E63946)，60%透明度突出
- **最後路徑**：紅色實線連接昨日到今日位置

🔧 **技術突破：**
- **時序衝突解決**：徹底修復4個不同分支的故事覆蓋問題
- **地圖實例修復**：解決"幽靈地圖"綁定問題，確保標記正確顯示
- **全域狀態管理**：`window.voiceStoryDisplayed` 標記系統
- **Firebase雙重保險**：自動初始化機制確保數據同步

💫 **使用者體驗：**
- **一鍵完整體驗**：按鈕後自動顯示軌跡、語音播放、故事顯示
- **無hover干擾**：移除所有動畫效果，專注內容本身
- **全螢幕恢復**：樹莓派DSI螢幕回到沉浸式全螢幕模式
- **語音故事保證**：語音生成的故事永不被後續API覆蓋

---

### 前版本歷史
**v3.0.0 - Nova 整合版** *(2025年1月)*
- ChatGPT Nova 多語言整合播放
- 高品質TTS系統和音頻格式轉換

## 🌍 專案概述

甦醒地圖是一個創新的地理探索應用，結合了時間感知、地理定位和智能推薦算法，為用戶提供個性化的全球城市體驗。每次互動都會根據當前時間計算出獨特的緯度偏好，並找到世界上符合條件的城市。

### 核心理念
- **時間驅動的地理探索**：不同時間對應不同緯度偏好
- **智能避重機制**：減少重複訪問相同城市
- **多語言體驗**：提供當地語言的問候和故事
- **跨平台同步**：網頁版與樹莓派實體裝置無縫整合

## 🎯 網頁版設計邏輯

### 1. 時間基礎的緯度計算系統

#### 標準時間段 (00:00-07:49, 08:11-23:59)
```javascript
// 基於分鐘數的線性映射
targetLatitude = 70 - (minutes * 140 / 59)
```

**設計原理：**
- **0分鐘** → 北緯70度（極地地區）
- **30分鐘** → 赤道0度（熱帶地區）  
- **59分鐘** → 南緯70度（南極地區）
- **避免極地問題**：限制在±70度範圍內，確保有人居住的地區

#### 特例時間段 (07:50-08:10)
```javascript
// 使用用戶當地位置
if (時間 === 7:50-8:10) {
    使用地理位置API獲取用戶當前位置
}
```

**設計考量：**
- **晨醒概念**：早晨時段應該在熟悉的環境甦醒
- **地理定位**：自動獲取用戶實際位置
- **優雅降級**：定位失敗時回到赤道附近

### 2. 智能城市選擇算法

#### 避重機制
```javascript
// 城市訪問統計追蹤
cityVisitStats = {
    "New York": 3,
    "Tokyo": 1,
    "Paris": 2
}

// 降低重複城市的選擇權重
weightedScore = baseScore * (1 / (visitCount + 1))
```

#### 多重篩選條件
1. **UTC時區匹配**：確保當地時間符合預期
2. **緯度偏好匹配**：根據時間計算的緯度範圍
3. **使用者歷史**：避免過度重複的城市
4. **資料品質**：優先選擇有完整翻譯的城市

### 3. 使用者體驗流程

#### 完整互動步驟
```
1. 用戶設定 → 輸入顯示名稱和組別
2. 按鈕觸發 → 計算當前時間的緯度偏好  
3. API調用 → 尋找符合條件的全球城市
4. 結果顯示 → 展示城市資訊和地圖位置
5. 語言體驗 → 播放當地語言問候
6. 故事生成 → 創建個性化旅行故事
7. 記錄保存 → 儲存到個人歷史和全域記錄
8. 圖片生成 → 創建城市特色早餐圖片
9. **[v4.0 新增]** 軌跡顯示 → 自動載入並顯示完整歷史路徑
```

## 🗺️ v4.0.0 軌跡視覺化系統

### 核心架構邏輯

#### 1. 自動軌跡載入機制
```javascript
// 統一的軌跡載入流程
按鈕觸發 → updateResultData → loadHistoryTrajectory → displayHistoryTrajectory
```

**關鍵特色：**
- **雙重保險Firebase初始化**：確保 `db` 和 `auth` 在軌跡載入前就緒
- **地圖實例修復**：檢查並重新綁定"幽靈地圖"實例到正確DOM容器
- **圖層管理**：清除舊圖層，創建新的 `historyMarkersLayer` 和 `trajectoryLayer`

#### 2. 視覺化樣式系統
```css
/* 歷史標記漸變透明度 */
opacity = Math.max(0.1, Math.min(0.8, 1 - (distanceFromLatest - 1) * 0.1))

/* 軌跡線分段處理 */
歷史軌跡: 灰色虛線 (#999999, dashArray: '5,5')
今日路徑: 紅色實線 (#E63946, weight: 3)
```

#### 3. 語音故事保護機制
```javascript
// 全域狀態管理
window.voiceStoryDisplayed = true/false
window.voiceStoryContent = [語音故事內容]

// 4個調用點保護
1. Firebase未初始化分支 → 標記保護
2. 正常分支 → 標記保護  
3. 錯誤分支 → 標記保護
4. generateAndDisplayStoryAndGreeting → 標記保護
```

### 關鍵修復說明

#### 問題1：軌跡不顯示 
**根因**：`mainInteractiveMap` 與 `mainMapContainer` 綁定失效
**解決**：`initBaseMapIfNeeded()` 檢查 `container._leaflet_map === mainInteractiveMap`

#### 問題2：語音故事被覆蓋
**根因**：`updateResultData` 中的 `generatePiStory` API 時序衝突
**解決**：所有 `updateResultData` 調用前設置全域標記

#### 問題3：地圖實例衝突
**根因**：多個地圖實例或"幽靈"未綁定實例
**解決**：容器清理 + 強制重新創建並綁定

### 技術注意事項

⚠️ **重要警告：**
1. **不要在 piStoryReady 事件中調用 updateResultData 而不設置語音故事標記**
2. **不要手動清理 historyMarkersLayer 而不重新創建**  
3. **不要忽略地圖實例綁定檢查，可能導致標記不顯示**
4. **不要在同一頁面生命週期中多次初始化地圖而不清理**

✅ **最佳實踐：**
1. **優先保護語音故事**：所有可能覆蓋的位置都要設置標記
2. **確保地圖綁定正確**：使用 `container._leaflet_map` 檢查
3. **按時序重置標記**：每次按按鈕時重置 `voiceStoryDisplayed = false`
4. **透明度漸變**：距離越遠的歷史點越透明，避免視覺干擾

## 🛠 技術架構

### 前端技術棧
- **HTML5 + CSS3**：響應式設計界面
- **Vanilla JavaScript**：純JS實現，無框架依賴
- **Leaflet.js**：互動式地圖顯示
- **Firebase SDK**：即時資料庫整合
- **Web APIs**：地理定位、語音合成

### 後端服務 (Vercel Serverless)
```
/api/find-city-geonames/    # GeoNames API 城市搜尋
/api/translate-location/    # 多語言地名翻譯  
/api/generateStory/         # AI 故事生成
/api/generateImage/         # AI 圖片生成
/api/generateMorningGreeting/  # 當地語言問候 + 中文故事生成 (v3.0 新增)
/api/save-record/          # 記錄同步 (樹莓派專用)
```

### 🎵 TTS 語音系統架構 (v3.0.0)

#### OpenAI ChatGPT Nova 引擎
```
主要配置：
├── Engine: OpenAI TTS-HD
├── Voice: Nova (多語言優化)
├── Model: tts-1-hd (高品質)
├── Speed: 1.0 (自然語速)
└── Output: MP3 → WAV 自動轉換

智能模式選擇：
├── 整合模式：Nova 一次性播放多語言內容
├── 分離模式：Nova 分別播放問候語和故事  
└── 備用機制：espeak/festival 作為備用引擎
```

#### 音頻處理流程
```
1. API 請求 → 獲取當地問候語 + 中文故事
2. 內容整合 → "¡Buenos días! 今天的你在..."
3. OpenAI TTS → 生成高品質 MP3 音頻
4. 格式轉換 → ffmpeg MP3→WAV 無損轉換
5. 音頻播放 → pygame 播放器 + 多重備用機制
6. 快取機制 → 本地快取減少 API 調用
```

### 資料庫設計 (Firebase Firestore)
```
userHistory/              # 使用者個人歷史
├── 文件ID
    ├── userDisplayName   # 顯示名稱
    ├── city/country      # 城市國家 (中英文)
    ├── coordinates       # GPS座標
    ├── timezone          # 時區資訊
    ├── recordedAt        # 記錄時間
    └── deviceType        # 裝置類型

globalDailyRecords/       # 全域每日記錄
├── 文件ID  
    ├── 同上結構
    └── 用於眾人地圖顯示
```

## 🎮 使用者功能詳解

### 1. 個人化設定
- **顯示名稱**：用於記錄識別和社群分享
- **組別設定**：支援團體使用和統計分析
- **資料持久化**：使用 localStorage 保存設定

### 2. 甦醒體驗
- **時間感知**：每個時間點都有獨特的探索體驗
- **地理多樣性**：覆蓋全球 195+ 個國家和地區
- **文化沉浸**：當地語言問候 + 文化背景故事

#### 🤖 ChatGPT Nova 多語言整合播放 (v3.0.0 新功能)

**🌟 整合模式：**
```
用戶體驗流程：
1. 按下按鈕 → 甦醒在墨西哥城
2. Nova 播放：「¡Buenos días! 今天的你在墨西哥城甦醒，感受陽光灑落...」
3. 無縫體驗：當地語言問候直接接入中文故事，完全無停頓
```

**🎵 音質對比：**
- ❌ **v2.x 版本**：espeak 機械音「¡Buenos días!」→ [停頓] → Nova 流暢音「今天的你在...」
- ✅ **v3.0 版本**：Nova 全程「¡Buenos días! 今天的你在墨西哥城甦醒...」

**🔧 技術特色：**
- **智能語言檢測**：Nova 自動處理多語言內容
- **無縫音頻整合**：一個音頻文件包含當地問候+中文故事
- **模式靈活切換**：支援整合模式/分離模式一鍵切換
- **高品質音質**：OpenAI TTS-HD 提供流暢自然的語音
- **全語言支援**：支援西班牙語、法語、日語、韓語等 50+ 種語言

**🎛️ 控制工具：**
```bash
# 檢查和切換播放模式
python3 toggle_nova_mode.py

# 模式選項：
1. Nova 整合模式 (推薦) - 無縫播放
2. 分離模式 - 分別播放問候語和故事
3. 傳統模式 - 使用 espeak/festival
```

### 3. 記錄系統
- **個人軌跡**：查看自己的甦醒歷史
- **眾人地圖**：探索其他人的甦醒足跡
- **統計分析**：城市訪問頻率和偏好分析

### 4. 智能避重
- **訪問統計**：追蹤每個城市的訪問次數
- **權重調整**：降低重複城市的選中機率
- **新鮮感保持**：鼓勵探索更多不同城市

## 🤖 樹莓派整合

### 實體裝置同步
- **使用者設定**：自動配置為 "future" 使用者
- **按鈕觸發**：物理按鈕觸發相同的甦醒邏輯
- **記錄同步**：透過 `/api/save-record` 同步到網站
- **音頻體驗**：本地播放多語言問候

### 裝置類型支援
- `web_browser`：網頁版使用者
- `raspberry_pi`：LCD 版樹莓派
- `raspberry_pi_dsi`：DSI 螢幕版樹莓派

## 🔧 API 端點詳解

### 城市搜尋 API
```javascript
POST /api/find-city-geonames
{
    "targetUTCOffset": 8.0,
    "targetLatitude": 25.0,
    "timeMinutes": 30,
    "userCityVisitStats": {"Tokyo": 2},
    "useLocalPosition": false
}
```

### 記錄同步 API  
```javascript
POST /api/save-record
{
    "userDisplayName": "future",
    "city": "Tokyo",
    "country": "Japan",
    "latitude": 35.6762,
    "longitude": 139.6503,
    "deviceType": "raspberry_pi"
}
```

## 🌐 多語言支援

### 支援語言列表
中文、英文、日文、韓文、法文、德文、西班牙文、意大利文、俄文、阿拉伯文、泰文、越南文、印尼文、馬來文、土耳其文等 15+ 種語言

### 語言選擇邏輯
1. **國家代碼映射**：根據城市所在國家自動選擇
2. **備用方案**：未知國家使用英文
3. **發音優化**：使用 Web Speech API 進行語音合成

## 📱 響應式設計

### 裝置適配
- **桌面版**：完整功能體驗，大螢幕地圖
- **平板版**：適中的界面佈局和互動元素  
- **手機版**：簡化界面，觸控優化

### 效能優化
- **延遲載入**：地圖和圖片按需載入
- **錯誤處理**：網路異常時的優雅降級
- **快取機制**：減少重複的 API 呼叫

## 🔒 隱私與安全

### 資料保護
- **匿名使用**：可選擇匿名模式探索
- **本地儲存**：敏感設定存於本地端
- **HTTPS 加密**：所有 API 通信使用 HTTPS

### 地理隱私
- **位置控制**：用戶主動同意才使用定位
- **特例時段**：僅在 7:50-8:10 使用真實位置
- **位置混淆**：不存儲精確的用戶位置

## 🚀 部署與維護

### Vercel 部署
```bash
# 自動部署
git push origin main

# 環境變數配置
FIREBASE_API_KEY=your_api_key
GEONAMES_USERNAME=your_username
OPENAI_API_KEY=your_openai_key
```

### 監控與日誌
- **API 錯誤追蹤**：自動記錄 API 失敗
- **使用量統計**：追蹤功能使用頻率
- **效能監控**：載入時間和響應速度

## 📈 未來發展

### 功能擴展
- **社群功能**：使用者之間的互動和分享
- **AI 優化**：更智能的城市推薦算法
- **AR/VR 體驗**：沉浸式的城市探索

### 技術升級
- **PWA 支援**：離線使用和原生體驗
- **即時通信**：WebSocket 實現即時互動
- **機器學習**：個性化推薦優化

---

## 🏗 開發指南

### 本地開發
```bash
# 安裝依賴
npm install

# 啟動開發伺服器  
vercel dev

# 本地測試
open http://localhost:3000
```

### 程式碼結構
```
├── index.html          # 主頁面
├── script.js          # 核心邏輯
├── style.css          # 樣式表
├── api/               # 後端 API
│   ├── find-city-geonames/
│   ├── translate-location/
│   ├── generateStory/
│   ├── generateImage/
│   └── save-record/
└── raspberrypi/       # 樹莓派程式碼
    ├── main.py
    ├── api_client.py
    └── ...
```

## 📊 版本歷史

### v3.0.0 - Nova 整合版 (2025年1月)
🌟 **重大更新：ChatGPT Nova 多語言整合播放**
- ✨ 新增 Nova 整合模式：當地語言問候 + 中文故事無縫播放
- 🤖 全面升級為 OpenAI TTS-HD 高品質語音引擎
- 🎛️ 新增 `toggle_nova_mode.py` 模式切換工具
- 🔧 解決 espeak 音質問題，實現 100% Nova 播放
- 📱 新增詳細調試日誌和智能備用機制
- 🌍 支援 50+ 種語言的流暢自然語音

### v2.x - OpenAI TTS 基礎版
🚀 **音頻系統革新**
- 🎵 引入 OpenAI TTS 支援，告別傳統 TTS 限制
- 🔧 修復 MP3 格式轉換和播放問題
- 📋 完善音頻緩存和錯誤處理機制
- 🌏 支援中文、俄語等特殊語言 TTS

### v1.x - 基礎功能版
🏗️ **核心功能建立**
- 🌍 時間基礎的緯度計算系統
- 🎯 智能城市選擇算法與避重機制
- 📱 網頁版 + 樹莓派雙平台支援
- 🔊 基礎 TTS 功能 (Festival/espeak)
- 📊 Firebase 資料庫整合
- 🗺️ Leaflet 地圖視覺化

---

## 🚀 v4.0.0 使用指南

### 🎯 最佳體驗步驟
1. **首次使用**：設定使用者名稱，建議使用英文或數字
2. **按實體按鈕**：GPIO18物理按鈕觸發（樹莓派版本）
3. **等待完整流程**：語音播放 → 故事顯示 → 軌跡繪製自動完成
4. **觀察軌跡地圖**：歷史足跡自動顯示，無需手動操作

### ⚡ 新功能使用技巧
- **軌跡觀察**：每次使用後會自動添加新的歷史點並更新路徑
- **語音故事**：優先顯示語音生成內容，確保與音頻同步
- **全螢幕體驗**：樹莓派DSI螢幕自動進入全螢幕沉浸模式
- **快捷鍵**：F11切換全螢幕，Escape退出全螢幕

### 🔧 故障排除
如果軌跡不顯示：
```javascript
// 手動檢查地圖狀態
console.log('地圖狀態:', !!window.mainInteractiveMap);
console.log('圖層狀態:', !!window.historyMarkersLayer);

// 手動觸發軌跡載入
loadHistoryTrajectory();
```

如果語音故事被覆蓋：
```javascript
// 檢查保護狀態
console.log('語音故事保護:', window.voiceStoryDisplayed);
console.log('語音故事內容:', window.voiceStoryContent?.substring(0, 50));
```

## 🎯 未來規劃

### ✅ v4.0.0 完成項目
- **軌跡視覺化系統**：完整歷史路徑自動顯示
- **語音故事保護**：解決時序衝突問題
- **視覺體驗優化**：透明度漸變和樣式美化

### 🔮 後續版本
- **v4.1**：軌跡統計分析和個人地圖報告
- **v4.2**：社群軌跡分享和好友系統
- **v5.0**：AI動態城市圖片生成和AR體驗
- **v5.1**：多人協作模式和即時互動

---

這個甦醒地圖專案融合了地理學、時間哲學和人工智能，為使用者創造獨特的全球探索體驗。每一次的「甦醒」都是一次新的發現之旅！ 🌍✨

**目前版本：v4.0.0 - 完整軌跡視覺化，語音故事完美保護！** 🗺️🎵✨