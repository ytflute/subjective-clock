# 🍓 Raspberry Pi 模組化版本安裝指南

## 📋 **安裝前準備**

### **檢查當前版本**
```bash
# SSH 連接到樹莓派
ssh future@raspberrypi

# 查看當前項目狀態
cd ~/pi/subjective-clock
git status
git log --oneline -3
```

### **備份現有版本** (重要！)
```bash
# 備份當前的 pi.html
cp pi.html pi.html.backup.$(date +%Y%m%d_%H%M%S)

# 確認備份
ls -la pi.html*
```

---

## 🚀 **方法一：Git 同步更新 (推薦)**

### **步驟 1: 更新代碼庫**
```bash
# 確保在正確目錄
cd ~/pi/subjective-clock

# 儲存本地修改 (如果有)
git stash

# 拉取最新版本
git pull origin main

# 檢查是否成功更新
git log --oneline -3
```

### **步驟 2: 驗證新文件**
```bash
# 檢查組件資料夾是否存在
ls -la components/

# 應該看到:
# waiting-state.html
# loading-state.html  
# result-state.html
# component-loader.js

# 檢查模組化主文件
ls -la pi-modular.html
```

### **步驟 3: 啟用模組化版本**
```bash
# 選項A: 替換原有文件 (推薦)
mv pi.html pi.html.original
mv pi-modular.html pi.html

# 選項B: 或者保持兩個版本並存
# 直接使用 pi-modular.html，無需改名
```

### **步驟 4: 更新主控制腳本引用**
```bash
# 檢查是否需要更新 main_web_dsi.py 中的 HTML 文件路徑
nano ~/pi/subjective-clock/raspberrypi-dsi/main_web_dsi.py

# 查找這一行 (大約在第 100 行左右):
# html_file = 'pi.html'

# 如果使用選項B，需要修改為:
# html_file = 'pi-modular.html'
```

---

## 🔧 **方法二：手動文件傳輸**

### **從你的電腦傳輸文件**
```bash
# 在你的電腦上 (從項目根目錄執行)

# 1. 傳輸組件資料夾
scp -r components/ future@raspberrypi:~/pi/subjective-clock/

# 2. 傳輸模組化主文件
scp pi-modular.html future@raspberrypi:~/pi/subjective-clock/

# 3. 傳輸重構版 JavaScript (如果還沒有)
scp pi-script-refactored.js future@raspberrypi:~/pi/subjective-clock/

# 4. 傳輸說明文檔
scp 模組化結構說明.md future@raspberrypi:~/pi/subjective-clock/
```

### **在樹莓派上整理文件**
```bash
# SSH 到樹莓派
ssh future@raspberrypi
cd ~/pi/subjective-clock

# 備份並替換
cp pi.html pi.html.backup
mv pi-modular.html pi.html

# 驗證文件權限
chmod 644 pi.html
chmod 644 components/*.html
chmod 644 components/*.js
```

---

## ✅ **安裝驗證**

### **步驟 1: 檢查文件結構**
```bash
# 在樹莓派上檢查完整結構
cd ~/pi/subjective-clock
tree -L 2

# 或者使用 ls
ls -la
ls -la components/

# 應該看到類似這樣的結構:
# pi.html (模組化版本)
# pi-script-refactored.js
# components/
#   ├── waiting-state.html
#   ├── loading-state.html
#   ├── result-state.html
#   └── component-loader.js
```

### **步驟 2: 測試 Web 服務器**
```bash
# 如果有運行 web 服務器，重啟它
sudo systemctl restart nginx
# 或者
sudo systemctl restart apache2

# 或者如果使用 Python 開發服務器
pkill -f "python.*http.server"
cd ~/pi/subjective-clock
python3 -m http.server 8000 &
```

### **步驟 3: 瀏覽器測試**
```bash
# 在樹莓派本地瀏覽器中訪問
# http://localhost:8000/pi.html
# 或者
# http://raspberrypi.local:8000/pi.html

# 檢查瀏覽器控制台，應該看到:
# 📦 組件載入器已初始化
# 🔘 等待狀態組件已載入
# ⏳ 載入狀態組件已載入
# 📊 結果狀態組件已載入
# 🎉 所有組件已載入完成
```

---

## 🔧 **主控制程式更新**

### **檢查 main_web_dsi.py 配置**
```bash
cd ~/pi/subjective-clock/raspberrypi-dsi
nano main_web_dsi.py

# 查找 HTML 文件路徑配置 (大約第 100-120 行)
# 確保指向正確的 HTML 文件
```

如果發現配置需要更新：
```python
# 舊的配置可能是:
# html_file = 'pi.html'

# 如果你使用了不同的文件名，更新為:
# html_file = 'pi-modular.html'  # 或者保持 'pi.html' 如果已經替換
```

### **重啟主控制程式**
```bash
# 如果有 autostart 服務
sudo systemctl restart wakeupclock

# 或者手動重啟
pkill -f main_web_dsi.py
cd ~/pi/subjective-clock/raspberrypi-dsi
python3 main_web_dsi.py &
```

---

## 🧪 **功能測試**

### **測試組件載入**
```bash
# 在瀏覽器控制台中執行 (F12 開啟控制台)
```
```javascript
// 檢查組件載入狀態
console.log('組件載入狀態:', {
    waiting: window.componentLoader.isLoaded('./components/waiting-state.html', '.main-display'),
    loading: window.componentLoader.isLoaded('./components/loading-state.html', '.main-display'),
    result: window.componentLoader.isLoaded('./components/result-state.html', '.main-display')
});

// 檢查管理器是否就緒
console.log('管理器狀態:', {
    resultManager: !!window.resultStateManager,
    loadingManager: !!window.loadingStateManager,
    componentLoader: !!window.componentLoader
});
```

### **測試頁面切換**
```javascript
// 測試狀態切換 (在瀏覽器控制台)
StateManager.setState('waiting');   // 應該顯示 Press Button 頁面
StateManager.setState('loading');   // 應該顯示 Locating 頁面  
StateManager.setState('result');    // 應該顯示 Result 頁面
```

### **測試隱藏按鈕**
```javascript
// 顯示隱藏按鈕 (在瀏覽器控制台)
hiddenButtonControl.show();

// 或者使用快捷鍵
// 按 ESC 鍵 - 應該臨時顯示緊急按鈕 5 秒
// 按 Ctrl + H - 應該觸發 startTheDay()
```

---

## 🚨 **故障排除**

### **問題 1: 組件載入失敗**
```bash
# 檢查文件權限
chmod -R 644 components/
chmod 755 components/

# 檢查文件是否存在
ls -la components/
cat components/waiting-state.html | head -10
```

### **問題 2: JavaScript 錯誤**
```bash
# 檢查 pi-script-refactored.js 是否存在
ls -la pi-script-refactored.js

# 如果不存在，從你的電腦傳輸
scp pi-script-refactored.js future@raspberrypi:~/pi/subjective-clock/
```

### **問題 3: 地圖不顯示**
在瀏覽器控制台檢查：
```javascript
// 檢查地圖狀態
console.log('地圖狀態:', {
    leafletLoaded: typeof L !== 'undefined',
    mapInstance: !!window.mainInteractiveMap,
    mapContainer: !!document.getElementById('mainMapContainer')
});
```

### **問題 4: 回退到原始版本**
```bash
# 如果有問題，快速回退
cd ~/pi/subjective-clock
mv pi.html pi-modular.html.backup
mv pi.html.backup pi.html

# 重啟服務
sudo systemctl restart wakeupclock
```

---

## 📊 **安裝完成檢查清單**

- [ ] ✅ 組件資料夾存在: `components/`
- [ ] ✅ 四個組件文件都存在且可讀
- [ ] ✅ 模組化主文件存在: `pi.html` 或 `pi-modular.html`
- [ ] ✅ 重構版 JavaScript 存在: `pi-script-refactored.js`
- [ ] ✅ 瀏覽器控制台無組件載入錯誤
- [ ] ✅ 可以看到 "Press The Button" 頁面
- [ ] ✅ 隱藏按鈕功能正常 (ESC 鍵測試)
- [ ] ✅ 主控制程式重啟成功
- [ ] ✅ GPIO 按鈕功能測試正常

---

## 🎉 **完成！**

現在你的樹莓派上運行的是**全新的模組化版本**！

### **主要優勢**
- 🔧 **更容易維護**: 每個頁面都是獨立文件
- 🐛 **更容易調試**: 錯誤隔離在特定組件
- 🚀 **更容易擴展**: 可以輕鬆添加新頁面組件
- 📱 **更好的開發體驗**: 修改組件立即生效

### **日常維護**
```bash
# 修改 Press Button 頁面
nano ~/pi/subjective-clock/components/waiting-state.html

# 修改載入頁面  
nano ~/pi/subjective-clock/components/loading-state.html

# 修改結果頁面
nano ~/pi/subjective-clock/components/result-state.html
```

如果遇到任何問題，可以查看 `模組化結構說明.md` 獲取更詳細的信息！🚀✨