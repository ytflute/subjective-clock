<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¦é†’åœ°åœ– Wake Up World Travel</title>
    
    <!-- ç¶²é åœ–æ¨™è¨­å®š -->
    <link rel="icon" href="favicon.ico">
    <link rel="icon" href="favicon-16x16.png" sizes="16x16" type="image/png">
    <link rel="icon" href="favicon-32x32.png" sizes="32x32" type="image/png">
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4d714f">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Wake Up World Travel">
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
</head>
<body>
    <div class="container">
        <h1>ç”¦é†’åœ°åœ– Wake Up Map <span style="font-size: 0.6em; color: #666;">(æ¨¡çµ„åŒ–ç‰ˆæœ¬)</span></h1>

        <div class="user-info-section">
            <div class="input-group-vertical">
                <div class="input-field">
                    <label for="userName">é¡¯ç¤ºåç¨±ï¼š</label>
                    <input type="text" id="userName" placeholder="è«‹è¼¸å…¥ä½ çš„é¡¯ç¤ºåç¨±">
                </div>
                <div class="input-field">
                    <label for="groupName">çµ„åˆ¥åç¨±ï¼š</label>
                    <input type="text" id="groupName" placeholder="è«‹è¼¸å…¥ä½ çš„çµ„åˆ¥åç¨±ï¼ˆé¸å¡«ï¼‰">
                </div>
                <!-- å¿ƒæƒ…é¸æ“‡å·²ç§»é™¤ï¼Œæ”¹ç”¨æŒ‰ä¸‹æŒ‰éˆ•çš„æ™‚é–“åˆ†é˜æ•¸æ±ºå®šç·¯åº¦åå¥½ -->
                
                <p class="action-description">æŒ‰ä¸‹æŒ‰éˆ•ï¼Œçœ‹çœ‹ä»Šå¤©çš„ä½ æ˜¯åœ¨åœ°çƒä¸Šçš„å“ªå€‹è§’è½ç”¦é†’ä¸¦é–‹å§‹é€™ä¸€å¤©ï¼Ÿ</p>
                
                <div class="button-row">
                    <button id="setUserNameButton" class="half-width-button">è¼‰å…¥è³‡æ–™</button>
                    <button id="findCityButton" class="half-width-button" disabled>é–‹å§‹é€™ä¸€å¤©</button>
                </div>
            </div>
            <div class="current-user-info">
                <span>ç›®å‰ä½¿ç”¨è€…ï¼š</span>
                <span id="currentUserId" class="highlight">æœªè¨­å®š</span>
                <span id="currentUserDisplayName" class="highlight">æœªè¨­å®š</span>
                <span id="currentGroupName" class="group-name"></span>
            </div>
        </div>

        <!-- Tab å°èˆª -->
        <div class="tab-navigation">
            <button class="tab-button active" data-tab="Clock">ğŸ• æ™‚é˜</button>
            <button class="tab-button" data-tab="History">ğŸ“œ æ­·å²</button>
            <button class="tab-button" data-tab="GlobalToday">ğŸŒ å…¨åŸŸ</button>
        </div>

        <!-- æ™‚é˜ Tab -->
        <div id="Clock" class="tab-content">
            <div class="info-section">
                <img id="countryFlag" src="" alt="åœ‹å®¶åœ‹æ——" style="display: none; width: 48px; height: auto; margin-bottom: 10px; border-radius: 4px;">
                <div id="resultText"></div>
                <div id="mapContainer"></div>
                <small id="debugInfo"></small>
            </div>
        </div>

        <!-- æ­·å² Tab -->
        <div id="History" class="tab-content" style="display: none;">
            <h2>ğŸ› æ­·å²è¨˜éŒ„</h2>
            <div class="history-controls">
                <label for="groupFilter">ç¯©é¸çµ„åˆ¥ï¼š</label>
                <select id="groupFilter">
                    <option value="">æ‰€æœ‰çµ„åˆ¥</option>
                </select>
                <button id="refreshHistoryButton">ğŸ”„ åˆ·æ–°æ­·å²</button>
            </div>
            
            <div class="history-display">
                <div class="history-list-container">
                    <h3>æ­·å²åˆ—è¡¨</h3>
                    <ul id="historyList"></ul>
                </div>
                
                <div class="history-map-container">
                    <h3>æ­·å²è»Œè·¡åœ°åœ–</h3>
                    <div id="historyMapContainer"></div>
                    <small id="historyDebugInfo"></small>
                </div>
            </div>
        </div>

        <!-- å…¨åŸŸä»Šæ—¥ Tab -->
        <div id="GlobalToday" class="tab-content" style="display: none;">
            <h2>ğŸŒ å…¨åŸŸä»Šæ—¥åœ°åœ–</h2>
            <div class="global-controls">
                <label for="globalDate">é¸æ“‡æ—¥æœŸï¼š</label>
                <input type="date" id="globalDate">
                <button id="refreshGlobalMapButton">ğŸ”„ è¼‰å…¥å…¨åŸŸåœ°åœ–</button>
            </div>
            
            <div id="globalTodayMapContainer"></div>
            <small id="globalTodayDebugInfo"></small>
        </div>
    </div>

    <!-- æ­·å²è¨˜éŒ„è©³ç´°å½ˆçª— -->
    <div id="historyLogModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ­·å²è¨˜éŒ„è©³ç´°ä¿¡æ¯</h3>
                <span class="close" id="historyLogModalClose">&times;</span>
            </div>
            <div class="modal-body" id="historyLogModalBody">
                <!-- å‹•æ…‹å…§å®¹å°‡åœ¨é€™è£¡ç”Ÿæˆ -->
            </div>
            <div class="modal-footer">
                <button id="closeModalFooterButton" class="button-secondary">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥çµ„ä»¶ -->
    <script>
        // å‹•æ…‹è¼‰å…¥çµ„ä»¶
        fetch('components/loading-state.html')
            .then(response => response.text())
            .then(html => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                document.body.appendChild(tempDiv.firstElementChild);
            })
            .catch(err => console.warn('ç„¡æ³•è¼‰å…¥ loading-state çµ„ä»¶:', err));

        fetch('components/result-state.html')
            .then(response => response.text())
            .then(html => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                document.body.appendChild(tempDiv.firstElementChild);
            })
            .catch(err => console.warn('ç„¡æ³•è¼‰å…¥ result-state çµ„ä»¶:', err));

        fetch('components/waiting-state.html')
            .then(response => response.text())
            .then(html => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                document.body.appendChild(tempDiv.firstElementChild);
            })
            .catch(err => console.warn('ç„¡æ³•è¼‰å…¥ waiting-state çµ„ä»¶:', err));
    </script>

    <!-- Firebase SDK -->
    <script type="module">
        console.log("ğŸ”¥ é–‹å§‹è¼‰å…¥ Firebase SDK...");
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithCustomToken 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            where, 
            getDocs, 
            orderBy, 
            serverTimestamp, 
            doc, 
            setDoc, 
            getDoc, 
            limit, 
            updateDoc,
            setLogLevel
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // å°‡ Firebase SDK å‡½æ•¸è¨­ç‚ºå…¨åŸŸå¯ç”¨
        window.firebaseSDK = {
            initializeApp,
            getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
            getFirestore, collection, addDoc, query, where, getDocs, orderBy, serverTimestamp, doc, setDoc, getDoc, limit, updateDoc,
            setLogLevel
        };

        console.log("âœ… Firebase SDK è¼‰å…¥å®Œæˆ");

        // è§¸ç™¼ firebaseReady äº‹ä»¶
        const firebaseReadyEvent = new CustomEvent('firebaseReady');
        window.dispatchEvent(firebaseReadyEvent);
        console.log("ğŸ“¡ firebaseReady äº‹ä»¶å·²è§¸ç™¼");
    </script>

    <!-- Leaflet åœ°åœ–åº« -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <!-- Firebase é…ç½® -->
    <script>
        // å¾ API è¼‰å…¥ Firebase é…ç½®
        fetch('/api/config')
            .then(response => response.json())
            .then(config => {
                console.log("ğŸ”§ Firebase é…ç½®å·²è¼‰å…¥");
                window.firebaseConfig = config.firebaseConfig;
                window.appId = config.appId;
                
                // å¦‚æœæ¨¡çµ„åŒ–è…³æœ¬å·²ç¶“è¼‰å…¥ï¼Œç›´æ¥åˆå§‹åŒ–
                if (window.subjectiveClockApp) {
                    console.log("ğŸš€ é…ç½®è¼‰å…¥å¾Œç«‹å³åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼");
                    window.startApp();
                }
            })
            .catch(error => {
                console.error("âŒ ç„¡æ³•è¼‰å…¥ Firebase é…ç½®:", error);
                
                // ä½¿ç”¨é è¨­é…ç½®ä½œç‚ºå‚™ç”¨
                window.firebaseConfig = {
                    // é€™è£¡å¯ä»¥æ”¾ç½®å‚™ç”¨é…ç½®
                };
                window.appId = 'default-app-id-worldclock-history';
            });
    </script>

    <!-- çµ„ä»¶è¼‰å…¥å™¨ -->
    <script src="components/component-loader.js"></script>

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼ - æ¨¡çµ„åŒ–ç‰ˆæœ¬ -->
    <script type="module" src="js/script-modular.js"></script>

    <!-- ç‰ˆæœ¬ä¿¡æ¯ -->
    <script>
        console.log("ğŸ“± ç”¦é†’åœ°åœ– - æ¨¡çµ„åŒ–ç‰ˆæœ¬");
        console.log("ğŸ—ï¸ æ¶æ§‹: ES6 æ¨¡çµ„ + é¡åˆ¥å°å‘è¨­è¨ˆ");
        console.log("ğŸ”§ ç‰¹è‰²: å¯ç¶­è­·æ€§ã€å¯æ¸¬è©¦æ€§ã€å¯æ“´å±•æ€§");
        console.log("ğŸ“Š æ¨¡çµ„: é…ç½®ã€å·¥å…·ã€æ™‚é–“è¨ˆç®—ã€Firebaseã€åŸå¸‚æœå‹™ã€åœ°åœ–æœå‹™ã€UIç®¡ç†ã€äº‹ä»¶è™•ç†");
    </script>
</body>
</html>
