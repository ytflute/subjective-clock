<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=800, initial-scale=1.0">
    <title>甦醒地圖 Raspberry Pi</title>
    
    <!-- 網頁圖標設定 -->
    <link rel="icon" href="favicon.ico">
    <link rel="icon" href="favicon-16x16.png" sizes="16x16" type="image/png">
    <link rel="icon" href="favicon-32x32.png" sizes="32x32" type="image/png">
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <meta name="theme-color" content="#4d714f">
    
    <link rel="stylesheet" href="pi-style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
</head>
<body>
    <div class="container">
        <header class="pi-header">
            <h1>甦醒地圖</h1>
            <div class="status-indicator">
                <div id="connectionStatus" class="status-dot"></div>
                <span id="currentUser">使用者：future</span>
            </div>
        </header>

        <!-- 主要顯示區域 -->
        <main class="main-display">
            <!-- 等待狀態 -->
            <div id="waitingState" class="waiting-state active">
                <div class="waiting-content">
                    <div class="waiting-animation">
                        <div class="pulse-circle"></div>
                        <div class="pulse-circle delay-1"></div>
                        <div class="pulse-circle delay-2"></div>
                    </div>
                    <h2 class="waiting-text">準備探索今日甦醒...</h2>
                    <p class="waiting-subtitle">按下按鈕開始您的甦醒之旅</p>
                </div>
            </div>

            <!-- 載入狀態 -->
            <div id="loadingState" class="loading-state">
                <div class="loading-content">
                    <div class="loading-spinner"></div>
                    <h2 class="loading-text">尋找您的甦醒城市...</h2>
                    <p class="loading-subtitle">正在探索世界的美好角落</p>
                </div>
            </div>

            <!-- 結果顯示區域 -->
            <div id="resultState" class="result-state">
                <div class="city-info">
                    <div class="city-main">
                        <h2 id="cityName" class="city-name"></h2>
                        <div class="country-info">
                            <img id="countryFlag" class="country-flag" src="" alt="國旗" style="display:none;"/>
                            <h3 id="countryName" class="country-name"></h3>
                        </div>
                    </div>
                    <div id="greetingText" class="greeting-text"></div>
                </div>

                <div class="map-section">
                    <div id="mapContainer" class="map-container"></div>
                    <div id="coordinateInfo" class="coordinate-info"></div>
                </div>
            </div>

            <!-- 錯誤狀態 -->
            <div id="errorState" class="error-state">
                <div class="error-content">
                    <div class="error-icon">⚠️</div>
                    <h2 class="error-text">暫時無法連接</h2>
                    <p id="errorMessage" class="error-subtitle">請稍候再試</p>
                </div>
            </div>
        </main>

        <!-- 隱藏元素 (用於保持相容性) -->
        <div style="display: none;">
            <input type="hidden" id="groupName" value="">
            <input type="hidden" id="userName" value="future">
            
            <!-- 虛擬按鈕元素，供原有 JavaScript 相容 -->
            <button id="setUserNameButton" class="load-button">載入資料</button>
            <button id="findCityButton" class="start-button">開始這一天</button>
            
            <!-- 相容性元素 -->
            <div id="resultText" class="result-text"></div>
            <div id="debugInfo" class="debug-info"></div>
            <div id="currentUserId">future</div>
            <div id="currentUserDisplayName">future</div>
            
            <!-- 分頁相關隱藏元素 -->
            <ul id="historyList"></ul>
            <div id="historyMapContainer"></div>
            <div id="historyDebugInfo"></div>
            <button id="refreshHistoryButton"></button>
            <input type="date" id="globalDate">
            <select id="groupFilter"><option value="all">所有人</option></select>
            <button id="refreshGlobalMapButton"></button>
            <div id="globalTodayMapContainer"></div>
            <div id="globalTodayDebugInfo"></div>
        </div>
    </div>

    <!-- 載入彈跳式日誌視窗 -->
    <div id="historyLogModal" class="modal" style="display:none;">
        <div class="modal-dialog">
            <div class="modal-content-wrapper">
                <div class="modal-header">
                    <h2 id="modalTitle">甦醒日誌詳情</h2>
                    <span id="historyLogModalClose" class="modal-close-button">&times;</span>
                </div>
                <div id="historyLogModalContent" class="modal-body"></div>
                <div class="modal-footer">
                    <button id="closeModalFooterButton" class="modal-button-secondary">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 1. 首先載入 Firebase 配置 -->
    <script src="/api/config"></script>

    <!-- 2. 載入 Firebase SDK 並初始化 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js';
        import { 
            getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken
        } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js';
        import { 
            getFirestore, collection, addDoc, query, where, getDocs, orderBy, 
            serverTimestamp, doc, setDoc, getDoc, limit, updateDoc, setLogLevel
        } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js';

        // Firebase 配置將由 /api/config 端點提供
        if (window.firebaseConfig) {
            const app = initializeApp(window.firebaseConfig);
            
            // 打包所有 Firebase 功能供主腳本使用
            window.firebaseSDK = {
                initializeApp,
                getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
                getFirestore, collection, addDoc, query, where, getDocs, orderBy, 
                serverTimestamp, doc, setDoc, getDoc, limit, updateDoc, setLogLevel
            };
            
            // 發送 Firebase 就緒事件
            window.dispatchEvent(new CustomEvent('firebaseReady'));
        } else {
            console.error('Firebase 配置未載入');
        }
    </script>

    <!-- 3. 載入 Leaflet 地圖庫 -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <!-- 4. 載入主要應用程式腳本 -->
    <script src="pi-script.js"></script>
</body>
</html> 