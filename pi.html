<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=800, initial-scale=1.0">
    <title>甦醒地圖 Raspberry Pi</title>
    
    <!-- 網頁圖標設定 -->
    <link rel="icon" href="favicon.ico">
    <link rel="icon" href="favicon-16x16.png" sizes="16x16" type="image/png">
    <link rel="icon" href="favicon-32x32.png" sizes="32x32" type="image/png">
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <meta name="theme-color" content="#4d714f">
    
    <!-- Google Fonts - Pixel/Digital 風格字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Orbitron:wght@400;700;900&family=VT323&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="pi-style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
</head>
<body>
    <div class="container">
        

        <!-- 主要顯示區域 -->
        <main class="main-display">
            <!-- 等待狀態 -->
            <div id="waitingState" class="waiting-state active">
                <div class="waiting-content">
                    <div class="waiting-animation">
                        <div class="pulse-circle"></div>
                        <div class="pulse-circle delay-1"></div>
                        <div class="pulse-circle delay-2"></div>
                    </div>
                    <h2 class="waiting-text">按下按鈕，喚醒今日的你！</h2>
                </div>
            </div>

            <!-- 載入狀態 -->
            <div id="loadingState" class="loading-state">
                <div class="loading-content">
                    <div class="loading-spinner"></div>
                    <h2 class="loading-text">定位你的甦醒位置中....</h2>
                    <p class="loading-subtitle"></p>
                </div>
            </div>

            <!-- 結果顯示區域 - 新布局 -->
            <div id="resultState" class="result-state">
                <div class="result-layout">
                    <!-- 左側內容區 -->
                    <div class="left-content">
                        <!-- 城市名稱大標題 -->
                        <div class="city-title-section">
                            <h1 id="cityName" class="city-title blink-text"></h1>
                        </div>
                        
                        <!-- 國家信息區 -->
                        <div class="country-section">
                            <div class="country-info-row">
                                <div class="flag-container">
                                    <img id="countryFlag" class="country-flag" src="" alt="國旗" style="display:none;"/>
                                    
                                </div>
                                <h2 id="countryName" class="country-title"></h2>
                            </div>
                            
                            <!-- 故事內容區移到國家信息區內，在圖片下方 -->
                            <div class="story-section">
                                <div id="greetingText" class="story-content"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 右側地圖按鈕區 -->
                    <div class="right-content">
                        <div class="map-button-container">
                            <button id="mapButton" class="map-button">
                                地圖
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 隱藏的地圖容器 -->
                <div id="mapContainer" class="map-container hidden"></div>
                <div id="coordinateInfo" class="coordinate-info"></div>
            </div>

            <!-- 錯誤狀態 -->
            <div id="errorState" class="error-state">
                <div class="error-content">
                    <div class="error-icon">⚠️</div>
                    <h2 class="error-text">暫時無法連接</h2>
                    <p id="errorMessage" class="error-subtitle">請稍候再試</p>
                </div>
            </div>
        </main>

        <!-- 隱藏元素 (用於保持相容性) -->
        <div style="display: none;">
            <input type="hidden" id="groupName" value="">
            <input type="hidden" id="userName" value="future">
            
            <!-- 虛擬按鈕元素，供原有 JavaScript 相容 -->
            <button id="setUserNameButton" class="load-button">載入資料</button>
            <button id="findCityButton" class="start-button">開始這一天</button>
            
            <!-- 相容性元素 -->
            <div id="resultText" class="result-text"></div>
            <div id="debugInfo" class="debug-info"></div>
            <div id="currentUserId">future</div>
            <div id="currentUserDisplayName">future</div>
            
            <!-- 分頁相關隱藏元素 -->
            <ul id="historyList"></ul>
            <div id="historyMapContainer"></div>
            <div id="historyDebugInfo"></div>
            <button id="refreshHistoryButton"></button>
            <input type="date" id="globalDate">
            <select id="groupFilter"><option value="all">所有人</option></select>
            <button id="refreshGlobalMapButton"></button>
            <div id="globalTodayMapContainer"></div>
            <div id="globalTodayDebugInfo"></div>
        </div>
    </div>

    <!-- 清喉嚨彈出對話框 -->
    <div class="popup-overlay" id="popupOverlay"></div>
    <div class="throat-clearing-popup" id="throatClearingPopup">
        <div class="throat-clearing-text">
            剛起床，正在清喉嚨<br>
            請稍待
        </div>
        <div class="throat-clearing-dots">...</div>
    </div>
    
    <!-- 載入彈跳式日誌視窗 -->
    <div id="historyLogModal" class="modal" style="display:none;">
        <div class="modal-dialog">
            <div class="modal-content-wrapper">
                <div class="modal-header">
                    <h2 id="modalTitle">甦醒日誌詳情</h2>
                    <span id="historyLogModalClose" class="modal-close-button">&times;</span>
                </div>
                <div id="historyLogModalContent" class="modal-body"></div>
                <div class="modal-footer">
                    <button id="closeModalFooterButton" class="modal-button-secondary">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 1. 首先載入 Firebase 配置 -->
    <script src="/api/config"></script>

    <!-- 2. 載入 Firebase SDK 並初始化 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js';
        import { 
            getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken
        } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js';
        import { 
            getFirestore, collection, addDoc, query, where, getDocs, orderBy, 
            serverTimestamp, doc, setDoc, getDoc, limit, updateDoc, setLogLevel
        } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js';

        // Firebase 配置將由 /api/config 端點提供
        if (window.firebaseConfig) {
            const app = initializeApp(window.firebaseConfig);
            
            // 打包所有 Firebase 功能供主腳本使用
            window.firebaseSDK = {
                initializeApp,
                getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
                getFirestore, collection, addDoc, query, where, getDocs, orderBy, 
                serverTimestamp, doc, setDoc, getDoc, limit, updateDoc, setLogLevel
            };
            
            // 發送 Firebase 就緒事件
            window.dispatchEvent(new CustomEvent('firebaseReady'));
        } else {
            console.error('Firebase 配置未載入');
        }
    </script>

    <!-- 3. 載入 Leaflet 地圖庫 -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <!-- 4. 載入主要應用程式腳本 -->
    <script src="pi-script.js"></script>
    
    <script>
        // 地圖切換功能
        function toggleMap() {
            const mapContainer = document.getElementById('mapContainer');
            const mapButton = document.getElementById('mapButton');
            
            if (mapContainer.classList.contains('hidden')) {
                mapContainer.classList.remove('hidden');
                mapButton.textContent = '隱藏地圖';
                mapButton.style.background = '#333';
                mapButton.style.color = '#fff';
                
                // 如果地圖還沒初始化，初始化它
                if (!window.currentMap) {
                    initializeMap();
                }
            } else {
                mapContainer.classList.add('hidden');
                mapButton.textContent = '地圖';
                mapButton.style.background = '#fff';
                mapButton.style.color = '#000';
            }
        }
        
        // 初始化地圖
        function initializeMap() {
            const mapContainer = document.getElementById('mapContainer');
            if (mapContainer && !window.currentMap) {
                // 使用原有的地圖初始化邏輯
                const latitude = window.currentLatitude || 25.0330;
                const longitude = window.currentLongitude || 121.5654;
                
                window.currentMap = L.map('mapContainer').setView([latitude, longitude], 10);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 18,
                    attribution: '© OpenStreetMap contributors'
                }).addTo(window.currentMap);
                
                // 添加標記
                L.marker([latitude, longitude]).addTo(window.currentMap)
                    .bindPopup(window.currentCityName || '甦醒位置')
                    .openPopup();
            }
        }
        
        // 當城市名稱更新時添加冒號
        function updateCityDisplay(cityName) {
            const cityElement = document.getElementById('cityName');
            if (cityElement && cityName) {
                cityElement.textContent = cityName.toUpperCase() + ':';
            }
        }
        
        // 監聽城市名稱變化
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList' || mutation.type === 'characterData') {
                    const cityElement = document.getElementById('cityName');
                    if (cityElement && cityElement.textContent && !cityElement.textContent.endsWith(':')) {
                        const cityName = cityElement.textContent.trim();
                        if (cityName && cityName !== '') {
                            updateCityDisplay(cityName);
                        }
                    }
                }
            });
        });
        
        // 開始觀察城市名稱元素
        document.addEventListener('DOMContentLoaded', function() {
            const cityElement = document.getElementById('cityName');
            if (cityElement) {
                observer.observe(cityElement, {
                    childList: true,
                    characterData: true,
                    subtree: true
                });
            }
        });
    </script>
</body>
</html> 